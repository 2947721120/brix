<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Brix'>/**
</span> * Brix配置类 组件框架入口类，在调用Brix组件的时候可以配置cdn地址，组件版本号等
 * @class Brix
 */
(function(S, Brix) {
    var isReady = false,
        readyList = [],
        win = window,
        loc = win.location,
        startsWith = S.startsWith,
        __pagePath = loc.href.replace(loc.hash, &quot;&quot;).replace(/[^/]*$/i, &quot;&quot;);
    Brix = win[Brix] = win[Brix] || {};

    //从KISSY源代码提取并改动适合brix的
<span id='global-method-absoluteFilePath'>    /**
</span>     * 相对路径文件名转换为绝对路径
     * @param path
     * @ignore
     */

    function absoluteFilePath(path) {
        path = S.trim(path);

        // path 为空时，不能变成 &quot;/&quot;
        if(path &amp;&amp; path.charAt(path.length - 1) != '/') {
            path += &quot;/&quot;;
        }

<span id='global-property-'>        /**
</span>         * 一定要正则化，防止出现 ../ 等相对路径
         * 考虑本地路径
         * @ignore
         */
        if(!path.match(/^(http(s)?)|(file):/i) &amp;&amp; !startsWith(path, &quot;/&quot;)) {
            path = __pagePath + path;
        }

        if(startsWith(path, &quot;/&quot;)) {
            var loc = win.location;
            path = loc.protocol + &quot;//&quot; + loc.host + path;
        }
        var paths = path.split(&quot;/&quot;),
            re = [],
            p;
        for(var i = 0; i &lt; paths.length; i++) {
            p = paths[i];
            if(p == &quot;.&quot;) {} else if(p == &quot;..&quot;) {
                re.pop();
            } else {
                re.push(p);
            }
        }
        path = re.join(&quot;/&quot;);
        return path.substring(0, path.length - 1);
    };

    function getBaseInfo() {
        // get path from current script file path
        // notice: timestamp
        var pathReg = /^(.*)brix(-min)?\.js[^/]*/i,
            pathTestReg = /brix(-min)?\.js/i,
            scripts = win.document.getElementsByTagName('script'),
            script = scripts[scripts.length - 1],
            src = absoluteFilePath(script.src),
            pathInfo = script.getAttribute(&quot;bx-config&quot;);
        if(pathInfo) {
            pathInfo = (new Function(&quot;return &quot; + pathInfo))();
        } else {
            pathInfo = {};
        }
        pathInfo.comboPrefix = pathInfo.comboPrefix || '??';
        pathInfo.comboSep = pathInfo.comboSep || ',';

        var comboPrefix = pathInfo.comboPrefix,
            comboSep = pathInfo.comboSep,
            parts = src.split(comboSep),
            path, part0 = parts[0],
            part01, index = part0.indexOf(comboPrefix);

        // no combo
        if(index == -1) {
            path = src.replace(pathReg, '$1');
        } else {
            path = part0.substring(0, index);
            part01 = part0.substring(index + 2, part0.length);
            // combo first
            // notice use match better than test
            if(part01.match(pathTestReg)) {
                path += part01.replace(pathReg, '$1');
            }
            // combo after first
            else {
                S.each(parts, function(part) {
                    if(part.match(pathTestReg)) {
                        path += part.replace(pathReg, '$1');
                        return false;
                    }
                });
            }
        }
        path = path.substring(0, path.lastIndexOf('brix'));
        return S.mix({
            path: path,
            componentsPath: './',
            importsPath: './'
        }, pathInfo);
    }
    var defaultOptions = getBaseInfo();
    var debug = '@DEBUG@'; //区分src还是dist版本
    var tag = '@TAG@'; //KISSY包时间戳
    var version = '@VERSION@'; //版本号
    var isConfig = false; //是否已经配置过
    S.mix(Brix, {
<span id='Brix-method-config'>        /**
</span>         * 配置路径
         * @param  {Object} options [配置对象]
         */
        config: function(options) {
            if(isConfig) {
                return;
            }
            isConfig = true;
            options = KISSY.merge({
                tag: tag == '@TAG@' ? '' : tag,
                fixed: version == '@VERSION@' ? '' : version + '/',
                //路径修正，brix路劲下存在其他文件夹
                gallery: {
                    //配置组件版本信息
                    //dropdown:'1.0'
                }
            }, defaultOptions, options);
            if(options.fixed == '@VERSION@') {
                options.fixed = '';
            }
            KISSY.config({
                packages: [{
                    name: &quot;brix&quot;,
                    path: options.path,
                    tag: options.tag,
                    charset: &quot;utf-8&quot;
                }, {
                    name: &quot;components&quot;,
                    path: options.componentsPath,
                    tag: options.componentsTag || options.tag,
                    charset: &quot;utf-8&quot;
                }, {
                    name: &quot;imports&quot;,
                    path: options.importsPath,
                    tag: options.importsTag || options.tag,
                    charset: &quot;utf-8&quot;
                }]
            });
            KISSY.config({
                map: [
                    [/(.+brix\/)(gallery\/)(.+?)(\/.+?(?:-min)?\.(?:js|css))(\?[^?]+)?$/, function($0, $1, $2, $3, $4, $5) {
                        var str = $1 + options.fixed + $2 + $3;
                        if(options.gallery[$3]) {
                            str += '/' + options.gallery[$3]
                        }
                        if(debug) {
                            $4 = $4.replace('-min', '');
                        }
                        str += $4 + ($5 ? $5 : '');
                        return str;
                    }],
                    [/(.+brix\/)(core.+?)((?:-min)?\.js)(\?[^?]+)?$/, function($0, $1, $2, $3, $4) {
                        var str = $1 + options.fixed;
                        if(debug) {
                            $3 = $3.replace('-min', '');
                        }
                        str += $2 + $3 + ($4 ? $4 : '');
                        return str;
                    }]
                ]
            });
        },
<span id='Brix-method-ready'>        /**
</span>         * 渲染完成后需要执行的函数
         * @param {Function} fn 执行的函数
         */
        ready: function(fn) {
            if(isReady) {
                fn.call(Brix);
            } else {
                readyList.push(fn);
            }
        },
<span id='Brix-method-_fireReady'>        /**
</span>         * 触发ready添加的方法
         * @private
         */
        _fireReady: function() {
            if(isReady) {
                return;
            }
            isReady = true;
            if(readyList) {
                var fn, i = 0;
                while(fn = readyList[i++]) {
                    fn.call(Brix);
                }
                readyList = null;
            }
        }
    });
    if(defaultOptions.autoConfig) {
        //自动配置
        Brix.config({});
        //自动实例化pagelet
        //外部调用的S.ready注册的方法中可以直接用Brix.pagelet实例书写业务逻辑
        if(defaultOptions.autoPagelet) {
            S.use('brix/core/pagelet', function(S, Pagelet) {
                S.ready(function() {
                    Brix.pagelet = new Pagelet({
                        tmpl: 'body'
                    });
                    Brix._fireReady();
                });
            });
            return;
        }
    }
    Brix._fireReady();
})(KISSY, 'Brix');</pre>
</body>
</html>
