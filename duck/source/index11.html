<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">KISSY.add(&quot;brix/gallery/form/index&quot;, function(S, Brick) {
    var KeyCodes = {
        ENTER: 13,
        SPACE: 32
    };

    function Form() {
        Form.superclass.constructor.apply(this, arguments);
    }
    Form.EVENTS = {
        '.checkbox, .radio': {
            'keyup': function (e) {
                if (e.keyCode === KeyCodes.ENTER ||
                    e.keyCode === KeyCodes.SPACE) {
                    S.one(e.target).fire('click');

                    // 空格键会触发页面滚动.
                    e.preventDefault();
                }
            }
        }
    };

    function handleStat(node, checkSiblings) {
        var input = node.one('.input');
        var _input = node.one('input');
        var isChecked = _input.prop('checked');
        var isDisabled = _input.prop('disabled');

        // patch for radio
        if (checkSiblings &amp;&amp; node.hasClass('radio')) {
            node.siblings('.radio').each(handleStat);
        }

        var className = 'input' +
                (isChecked ? ' checked' : '') +
                (isDisabled ? ' disabled' : '') +
                (isChecked &amp;&amp; isDisabled ? ' checked-disabled' : '');

        if (input) {
            input.attr('class', className);
        } else {
            node.prepend('&lt;span class=&quot;' + className + '&quot; tabindex=&quot;0&quot;&gt;&lt;/span&gt;');
        }
    }

    S.extend(Form, Brick, {
        initialize: function () {
            var el = this.get('el');

            el.addClass('bx-controls');
            el.all('.checkbox, .radio').each(handleStat);
            // 思路：不直接处理click事件，监听input状态变化来相应span的状态.
            el.all('input').on('change', function (e) {
                handleStat(S.one(e.currentTarget.parentNode), true);
            });
            // 1. 坑爹的IE6/7/8只能在input被渲染时click可以从label传递到input
            // 2. 坑爹的IE6/7只能在label有对应for属性时click才能传递到input，嵌套都不行
            //    ref: http://lucassmith.name/2008/04/label-checkbox-concerns.html
            // 这里统一隐藏掉input
            if (S.UA.ie &lt; 9) {
                el.all('.checkbox, .radio').on('click', function (e) {
                    // 避免循环触发.
                    if (e.target.nodeName === 'INPUT') { return; }

                    S.one(e.currentTarget).one('input')[0].click();
                });
            }
        }
    });
    return Form;
}, {
    requires: [&quot;brix/core/brick&quot;]
});
</pre>
</body>
</html>
