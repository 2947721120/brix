<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">KISSY.add(&quot;brix/core/tmpler&quot;, function(S, Mustache,Node) {
    var $ = Node.all;
<span id='Brix-Tmpler'>    /**
</span>     * 模板解析器，对传入的模板通过钩子进行分析，结合 Mustache 和数据给出 html 片段。
     * @class Brix.Tmpler
     * @param {String}  tmpl    模板字符串
     * @param {Number} level    对模板进行解析的层级，false表示不解析
     * @requires Brix.Mu
     */

    function Tmpler(tmpl, level) {
        if(tmpl &amp;&amp; (level !== false)) {
            this.tmpls = [];
            this._praseTmpl(tmpl,level);
        } else {
            this.tmpl = tmpl;
        }
    }

    S.extend(Tmpler, Object, {
<span id='Brix-Tmpler-method-_praseTmpl'>        /**
</span>         * 解析模板
         * @param  {String} tmpl  模板字符串
         * @param  {Number} level 对模板进行解析的层级，false表示不解析
         * @private
         */
        _praseTmpl: function(tmpl,level) {
            var self = this,
                inDom = false,
                node, tmplNode;
            if(typeof tmpl === 'string') {
                if(tmpl.charAt(0) === '.' || tmpl.charAt(0) === '#' || tmpl === 'body') {
                    node = $(tmpl);
                }
            } else {
                node = tmpl;
            }

            if(node) {
                if(node.item(0)[0].nodeName.toUpperCase() == 'SCRIPT') {
                    //如果是script节点，则直接取html
                    tmpl = node.item(0).html()
                } else {
                    inDom = true;
                }
            }

            if(!inDom) {
                var r = '&lt;([\\w]+)\\s+[^&gt;]*?bx-tmpl=[&quot;\']?([^&quot;\'\\s]+)[&quot;\']?\\s+[^&gt;]*?bx-datakey=[&quot;\']?([^&quot;\'\\s]+)[&quot;\']?[^&gt;]*?&gt;(@brix@)&lt;/\\1&gt;';
                while(level--){
                    r = r.replace('@brix@','(?:&lt;\\1[^&gt;]*&gt;@brix@&lt;/\\1&gt;|[\\s\\S])*?');
                }
                r = r.replace('@brix@','(?:[\\s\\S]*?)');
                self.reg = r;
                S.log(r);
                self.tmpl = self._replaceTmpl(tmpl);
                self._buildTmpls(self.tmpl);
            }
            self.inDom = inDom;
        },
<span id='Brix-Tmpler-method-_buildTmpls'>        /**
</span>         * 对节点中的bx-tmpl解析，构建模板和数据配置
         * @param  {String} tmpl  需要解析的模板
         * @private
         */
        _buildTmpls: function(tmpl) {
            var self = this;
            var r = new RegExp(self.reg,&quot;ig&quot;);
            while((m = r.exec(tmpl)) !== null) {
                self.tmpls.push({
                    name: m[2],
                    datakey: m[3],
                    tmpler: new Tmpler(m[4], false)
                });
                self._buildTmpls(m[4]);
            }
        },
<span id='Brix-Tmpler-method-_replaceTmpl'>        /**
</span>         * 移除子模板标签
         * @param  {String} tmpl 需要替换的模板
         * @return {String}      替换后的模板
         * @private
         */
        _replaceTmpl: function(tmpl) {
            //return tmpl;
            var r = /&lt;!--bx-tmpl=&quot;([^&quot;]+?)&quot;\s+bx-datakey=&quot;([^&quot;]+?)&quot;--&gt;(\s*([\s\S]*)?\s*)&lt;!--bx-tmpl=&quot;\1&quot;--&gt;/g,
                m;
            while(r.test(tmpl)) {
                tmpl = tmpl.replace(r, function(i, j, k, l) {
                    return l;
                });
                r.lastIndex = 0;
            }
            return tmpl;
        },

<span id='Brix-Tmpler-method-addTmpl'>        /**
</span>         * 添加子模板
         * @param {String} name    模板名称
         * @param {String} datakey 模板对应的数据key
         * @param {String} tmpl    子模板
         */
        addTmpl: function(name, datakey, tmpl) {
            var self = this;
            self.tmpls.push({
                id: name,
                datakey: datakey,
                tmpler: new Tmpler(tmpl, false)
            });
        },

<span id='Brix-Tmpler-method-getTmpl'>        /**
</span>         * 获取模板字符串
         * @return {String} 模板字符串
         */
        getTmpl: function() {
            return this.tmpl;
        },
<span id='Brix-Tmpler-method-to_html'>        /**
</span>         * 模板和数据渲染成字符串
         * @param  {Object} data 数据
         * @return {String}      html片段
         */
        to_html: function(data) {
            return Mustache.to_html(this.getTmpl(), data);
        }
    });
    return Tmpler;
}, {
    requires: ['./mu','node', 'sizzle']
});</pre>
</body>
</html>
