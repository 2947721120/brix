<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">KISSY.add('brix/gallery/pagination/index', function(S, Brick) {
<span id='Brix-Gallery-Pagination'>    /**
</span>     * Pagination 分页
     * &lt;br&gt;&lt;a href=&quot;../demo/gallery/pagination/pagination.html&quot; target=&quot;_blank&quot;&gt;Demo&lt;/a&gt;
     * @class Brix.Gallery.Pagination
     * @extends Brix.Brick
     */
    function Pagination() {
        Pagination.superclass.constructor.apply(this, arguments);
    }
    Pagination.ATTRS = {
<span id='Brix-Gallery-Pagination-cfg-mode'>        /**
</span>         * 模式，传统的第几页，还是记录条数,
         * 分为p 和s，p是传统模式，s是size总和模式
         * @cfg {Object}
         */
        mode: {
            value: 'p'
        },
<span id='Brix-Gallery-Pagination-property-offset'>        /**
</span>         * 页数显示偏移，默认0，
         * @type {Object}
         */
        offset:{
            value:0
        },
<span id='Brix-Gallery-Pagination-cfg-simplify'>        /**
</span>         * 是否精简模式
         * @cfg {Boolean}
         */
        simplify: {
            value: false
        },
<span id='Brix-Gallery-Pagination-cfg-step'>        /**
</span>         * 步长
         * @cfg {Number}
         */
        step: {
            value: 7
        },
<span id='Brix-Gallery-Pagination-cfg-index'>        /**
</span>         * 第几页
         * @cfg {Number}
         */
        index: {
            value: 1
        },
<span id='Brix-Gallery-Pagination-cfg-size'>        /**
</span>         * 每页的记录数
         * @cfg {Number}
         */
        size: {
            value: 15
        },
<span id='Brix-Gallery-Pagination-cfg-sizeChange'>        /**
</span>         * 是否可以修改每页记录数
         * @cfg {Boolean}
         */
        sizeChange: {
            value: false
        },
<span id='Brix-Gallery-Pagination-cfg-count'>        /**
</span>         * 总记录数
         * @cfg {Number}
         */
        count: {
            value: 350
        },
<span id='Brix-Gallery-Pagination-cfg-hascount'>        /**
</span>         * 是否有总记录数
         * @cfg {Boolean}
         */
        hascount: {
            value: true
        },
<span id='Brix-Gallery-Pagination-cfg-max'>        /**
</span>         * 最多页数
         * @cfg {Number}
         */
        max: {
            value: false
        },
<span id='Brix-Gallery-Pagination-cfg-hasmax'>        /**
</span>         * 是否认为限定最多页数
         * @cfg {Boolean}
         */
        hasmax: {
            value: false
        },
<span id='Brix-Gallery-Pagination-cfg-statistics'>        /**
</span>         * 是否显示统计信息
         * @cfg {Boolean}
         */
        statistics: {
            value: false
        },
<span id='Brix-Gallery-Pagination-cfg-pageCount'>        /**
</span>         * 是否显示总页数
         * @cfg {Boolean}
         */
        pageCount: {
            value: true
        },
<span id='Brix-Gallery-Pagination-cfg-jump'>        /**
</span>         * 是否有跳转
         * @cfg {Boolean}
         */
        jump: {
            value: false
        },
<span id='Brix-Gallery-Pagination-cfg-goTo'>        /**
</span>         * 是否直接跳转
         * @cfg {Boolean}
         */
        goTo: {
            value: true
        },
<span id='Brix-Gallery-Pagination-cfg-goToUrl'>        /**
</span>         * 跳转URL
         * @cfg {String}
         */
        goToUrl: {
            value: null
        },
<span id='Brix-Gallery-Pagination-cfg-pageName'>        /**
</span>         * 分页参数名
         * @cfg {String}
         */
        pageName: {
            value: 'page'
        },
<span id='Brix-Gallery-Pagination-cfg-pageSizeName'>        /**
</span>         * 每页记录数参数名
         * @cfg {String}
         */
        pageSizeName: {
            value: 'pagesize'
        },
<span id='Brix-Gallery-Pagination-cfg-params'>        /**
</span>         * 连接跳转的额外参数
         * @cfg {Object}
         */
        params: {
            value: false
        },
<span id='Brix-Gallery-Pagination-cfg-paramsArr'>        /**
</span>         * 参数值为数组时, 参数键是否加 [] 即 %5B%5D , 默认 false
         * @cfg {Boolean}
         */
        paramsArr:{
            value:false
        },
<span id='Brix-Gallery-Pagination-cfg-defaultUI'>        /**
</span>         * 是否用默认UI,多在seo中采用
         * @cfg {Boolean}
         */
        defaultUI: {
            value: true
        },
<span id='Brix-Gallery-Pagination-cfg-sizes'>        /**
</span>         * 每页记录数集合
         * @cfg {Array}
         */
        sizes: {
            value: [10, 15, 20, 25, 30]
        },
        //url信息
        urlInfo: {
            value: {}
        },
        //格式化url字符，内部参数
        formatUrl: {
            value: false
        }
    };

    Pagination.EVENTS = {
        '.page-num': {
            keydown: function(e) {
                if (e.keyCode === 13) {
                    e.preventDefault();
                    this._jumpPage();
                }
            }
        },
        '.btn-jump': {
            click: function(e) {
                e.preventDefault();
                this._jumpPage();
            }
        },
        'a': {
            'click': function(e) {
                var self = this,
                    target = S.one(e.currentTarget);
                if (target.hasClass('page')) {
                    e.preventDefault();
                    self.goToPage(parseInt(target.html(), 10));
                } else if (target.hasClass('page-prev')) {
                    e.preventDefault();
                    var index = self.get('index');
                    self.goToPage(index - 1);
                } else if (target.hasClass('page-next')) {
                    e.preventDefault();
                    var index = self.get('index');
                    self.goToPage(index + 1);
                }
            }
        }
    };
    Pagination.FIRES = {
<span id='Brix-Gallery-Pagination-event-beforeGotoPage'>        /**
</span>         * @event beforeGotoPage
         * 跳转前触发 return false 阻止跳转
         * @param {Object} e 
         * @param {Number} e.newIndex 新的页数
         * @param {Number} e.prevIndex 原页数
         * @type {String}
         */
        beforeGotoPage:'beforeGotoPage',
<span id='Brix-Gallery-Pagination-event-goToPage'>        /**
</span>         * @event goToPage
         * 跳转触发
         * @param {Object} e 
         * @param {Number} e.index 新的页数
         * @type {String}
         */
        goToPage:'goToPage',
<span id='Brix-Gallery-Pagination-event-gotoPage'>        /**
</span>         * @event gotoPage
         * 跳转触发
         * @param {Object} e 
         * @param {Number} e.index 新的页数
         * @type {String}
         */
        gotoPage:'gotoPage',
<span id='Brix-Gallery-Pagination-event-sizeChange'>        /**
</span>         * @event sizeChange
         * 每页显示记录数改变 
         * @param {Object} e 
         * @param {Number} e.size 记录数
         * @type {String}
         */
        sizeChange:'sizeChange'
    };

    Pagination.METHODS = {
<span id='Brix-Gallery-Pagination-method-goToPage'>        /**
</span>         * 页面跳转或者触发goToPage事件
         * @param  {Number} page 要跳转的页
         */
        goToPage: function(page) {
            var self = this,
                ret;
            ret = self.fire('beforeGotoPage', {
                newIndex: page,
                prevIndex: self.get('index')
            });

            if (ret === false) {
                //如果返回默认false，则取消后续事件
                return;
            }

            self.set('index', page);

            if(self.setConfig({index:page})){
                return;
            }

            self.fire('goToPage', {
                index: page
            });
            self.fire('gotoPage', {
                index: page
            });
        },
<span id='Brix-Gallery-Pagination-method-setConfig'>        /**
</span>         * 配置重置
         * @param {Object} config 配置对象
         * @return {Boolean} 是否跳转
         */
        setConfig: function(config) {
            var self = this,
                size = self.get('size');

            for (var key in config) {
                self.set(key, config[key]);
            }

            if (config.goToUrl) {
                self._setUrlInfo();
            }
            if (self.get('goTo')) {
                var url = self.doUrl();
                location.href = url;
                return true;
            }
            if (config.size &amp;&amp; config.size != size) {
                self.fire('sizeChange', {
                    size: config.size
                });
            }
            self._destroyDropdown();
            self._resizeConfig();
            self.renderUI();
            self._getDropDown();
            return false;
        },
<span id='Brix-Gallery-Pagination-method-parseUrl'>        /**
</span>         * 解析url
         * @param  {String} url url字符串
         * @return {Object}     解析后的URL对象
         */
        parseUrl: function(url) {
            var a = document.createElement('a');
            a.href = url;
            return {
                source: url,
                protocol: a.protocol.replace(':', ''),
                host: a.hostname,
                port: a.port,
                query: a.search,
                params: (function() { 
                    return S.unparam(a.search.replace(/^\?/, ''));
                })(),
                file: (a.pathname.match(/\/([^\/?#]+)$/i) || [, ''])[1],
                hash: a.hash.replace('#', ''),
                path: a.pathname.replace(/^([^\/])/, '/$1'),
                relative: (a.href.match(/tps?:\/\/[^\/]+(.+)/) || [, ''])[1],
                segments: a.pathname.replace(/^\//, '').split('/')
            };
        },
<span id='Brix-Gallery-Pagination-method-doUrl'>        /**
</span>         * 构建url
         * @return {String} url
         */
        doUrl: function() {
            var self = this,
                urlInfo = self.get('urlInfo'),
                index = self.get('index'),
                size = self.get('size'),
                pageName = self.get('pageName'),
                pageSizeName = self.get('pageSizeName'),
                returnUrl;
            urlInfo.params[pageName] = self._offset(index);
            if (pageSizeName) {
                urlInfo.params[pageSizeName] = size;
            } else if (urlInfo.params[pageSizeName]) {
                delete urlInfo.params[pageSizeName];
            }

            returnUrl = urlInfo.protocol + '://' + urlInfo.host;
            if (urlInfo.port != 0 &amp;&amp; urlInfo.port != 80) {
                returnUrl += ':' + urlInfo.port;
            }
            returnUrl += urlInfo.path + '?';


            returnUrl += S.param(urlInfo.params,'&amp;','=',self.get('paramsArr'));
            if (urlInfo.hash != '') {
                returnUrl += '#' + urlInfo.hash;
            }
            return returnUrl;
        }
    };

    S.extend(Pagination, Brick, {
        initialize: function() {
            var self = this;
            self._setUrlInfo();
            //从url信息中初始配置参数
            var urlInfo = self.get('urlInfo');
            var mode = self.get('mode'),
                offset = self.get('offset'),
                pageName = self.get('pageName'),
                pageSizeName = self.get('pageSizeName');

            if (pageSizeName &amp;&amp; urlInfo.params[pageSizeName]) {
                self.set('size', parseInt(urlInfo.params[pageSizeName], 10));
            }
            if (urlInfo.params[pageName]) {
                switch (mode) {
                case 'p':
                    self.set('index', parseInt(urlInfo.params[pageName], 10)-offset);
                    break;
                case 's':
                    var size = self.get('size');
                    self.set('index', (parseInt(urlInfo.params[pageName], 10)-(offset*size)) / size);
                    break;
                }
            }
            //对配置参数容错
            self._resizeConfig();
            if (self.get('defaultUI')) {
                self.renderUI();
            }
            self._getDropDown();
        },
        destructor: function() {
            this._destroyDropdown();
        },
        renderUI: function() {
            var self = this,
                mode = self.get('mode'),
                formatUrl = self.get('formatUrl'),
                step = self.get('step'),
                index = self.get('index'),
                max = self.get('max'),
                size = self.get('size'),
                count = self.get('count'),
                hascount = self.get('hascount'),
                pageCount = self.get('pageCount');
            var arrHTML = [];

            //render statistics
            if (self.get('statistics')) {
                arrHTML.push('&lt;div class=&quot;pagination-info&quot;&gt;&lt;span&gt;当前&lt;/span&gt;&lt;span class=&quot;b&quot;&gt;' + (count == 0 ? 0 : ((index - 1) * size + 1)) + '-' + Math.min(index * size, count) + '&lt;/span&gt;&lt;span&gt;条&lt;/span&gt;&lt;span class=&quot;mr&quot;&gt;共&lt;/span&gt;&lt;span class=&quot;b&quot;&gt;' + count + '&lt;/span&gt;&lt;span&gt;条&lt;/span&gt;&lt;span class=&quot;mr&quot;&gt;每页展现&lt;/span&gt;');
                if (self.get('sizeChange')) {
                    var sizes = self.get('sizes');
                    arrHTML.push('&lt;div class=&quot;dropdown&quot;&gt;' + '&lt;span class=&quot;dropdown-hd&quot;&gt;' + '&lt;span class=&quot;dropdown-text&quot; value=&quot;' + S.indexOf(size, sizes) + '&quot;&gt;' + size + '&lt;/span&gt;' + '&lt;/span&gt;' + '&lt;ul class=&quot;dropdown-list dropdown-list-noicon&quot;&gt;');
                    S.each(sizes, function(s, i) {
                        arrHTML.push('&lt;li class=&quot;dropdown-item' + (s == size ? ' dropdown-itemselected' : '') + '&quot;&gt;&lt;span value=&quot;' + i + '&quot;&gt;' + s + '&lt;/span&gt;&lt;/li&gt;');
                    });
                    arrHTML.push('&lt;/ul&gt;&lt;/div&gt;');
                } else {
                    arrHTML.push('&lt;span class=&quot;b&quot;&gt;' + size + '&lt;/span&gt;')
                }
                arrHTML.push('&lt;span&gt;条&lt;/span&gt;&lt;/div&gt;');
            }

            //pages
            arrHTML.push('&lt;div class=&quot;pagination-pages&quot;&gt;&lt;div class=&quot;pagination-page&quot;&gt;');

            if (index &gt; 1) {
                arrHTML.push('&lt;a title=&quot;上一页&quot; href=&quot;' + formatUrl.replace('{$p}',  self._offset(index - 1)) + '&quot; class=&quot;page-prev&quot;&gt;&lt;i class=&quot;iconfont&quot;&gt;&amp;#403&lt;/i&gt;&lt;/a&gt;');
            }
            if (self.get('simplify')) {
                arrHTML.push('&lt;span class=&quot;page-simply&quot;&gt;' + index + '/' + max + '&lt;/span&gt;');
            } else {
                var start = Math.max(1, index - parseInt(step / 2));
                var end = Math.min(max, start + step - 1);
                start = Math.max(1, end - step + 1);

                if (start &gt;= 3) {
                    arrHTML.push('&lt;a class=&quot;page&quot; href=&quot;' + formatUrl.replace('{$p}', self._offset(1)) + '&quot; title=&quot;第1页&quot;&gt;1&lt;/a&gt;');
                    arrHTML.push('&lt;a class=&quot;page&quot; href=&quot;' + formatUrl.replace('{$p}', self._offset(2)) + '&quot; title=&quot;第2页&quot;&gt;2&lt;/a&gt;');
                    if (start &gt; 3) {
                        arrHTML.push('&lt;span class=&quot;page-split&quot;&gt;...&lt;/span&gt;');
                    }
                } else if (start == 2) {
                    arrHTML.push('&lt;a class=&quot;page&quot; href=&quot;' + formatUrl.replace('{$p}', self._offset(1)) + '&quot; title=&quot;第1页&quot;&gt;1&lt;/a&gt;');
                }

                for (var i = start; i &lt;= end; i++) {
                    if (i === index) {
                        arrHTML.push('&lt;span class=&quot;page-cur&quot;&gt;' + i + '&lt;/span&gt;');
                    } else {
                        arrHTML.push('&lt;a class=&quot;page&quot; href=&quot;' + formatUrl.replace('{$p}', self._offset(i)) + '&quot; title=&quot;第' + i + '页&quot;&gt;' + i + '&lt;/a&gt;');
                    }
                }
                if (end + 2 &lt;= max) {
                    arrHTML.push('&lt;span class=&quot;page-split&quot;&gt;...&lt;/span&gt;');
                    if (hascount) {
                        arrHTML.push('&lt;a class=&quot;page&quot; href=&quot;' + formatUrl.replace('{$p}', self._offset(max)) + '&quot; title=&quot;第' + max + '页&quot;&gt;' + max + '&lt;/a&gt;');
                    }
                } else if (end &lt; max) {
                    arrHTML.push('&lt;a class=&quot;page&quot; href=&quot;' + formatUrl.replace('{$p}', self._offset(max)) + '&quot; title=&quot;第' + max + '页&quot;&gt;' + max + '&lt;/a&gt;');
                }
            }

            if (index != max) {
                arrHTML.push('&lt;a title=&quot;下一页&quot; href=&quot;' + formatUrl.replace('{$p}', self._offset(index + 1)) + '&quot; class=&quot;page-next&quot;&gt;&lt;i class=&quot;iconfont&quot;&gt;&amp;#402&lt;/i&gt;&lt;/a&gt;');
            }
            arrHTML.push('&lt;/div&gt;');
            if (hascount &amp;&amp; pageCount) {
                arrHTML.push('&lt;div class=&quot;pagination-count&quot;&gt;&lt;span&gt;共&lt;/span&gt;&lt;span class=&quot;b&quot;&gt;' + max + '&lt;/span&gt;&lt;span&gt;页&lt;/span&gt;&lt;/div&gt;');
            }
            //render Jump
            if (self.get('jump')) {
                arrHTML.push('&lt;div class=&quot;pagination-form&quot;&gt;&lt;span&gt;向第&lt;/span&gt;&lt;input class=&quot;page-num&quot; value=&quot;' + Math.min(max, index + 1) + '&quot; name=&quot;page&quot; type=&quot;text&quot;&gt;&lt;span&gt;页&lt;/span&gt;&lt;a class=&quot;btn-jump btn btn-size25&quot;&gt;跳转&lt;/a&gt;&lt;/div&gt;');
            }

            arrHTML.push('&lt;/div&gt;');

            self.get('el').html(arrHTML.join(''));

        },
<span id='Brix-Gallery-Pagination-method-_offset'>        /**
</span>         * 计算页数的偏移
         * @param  {Number} index 页数
         * @return {Number} 偏移后的值
         * @private
         */
        _offset:function(index){
            var self = this,
                mode = self.get('mode'),
                offset = self.get('offset');
            switch(mode){
                case 'p':
                    return index+offset;
                case 's':
                    var size = self.get('size');
                    return size*(index+offset);
                default:
                    return index+offset;
            }
        },
        _getDropDown: function() {
            var self = this;
            if (self.get('sizeChange') &amp;&amp; self.get('statistics')) {
                var dropdownNode = self.get('el').one('.dropdown');
                if (dropdownNode) {
                    var id = dropdownNode ? dropdownNode.attr('id') : false;
                    if (id &amp;&amp; self.pagelet) {
                        self.pagelet.ready(function(){
                            self.dropdown = self.pagelet.getBrick(id);
                            if(self.dropdown){
                                self._bindDropdownSizeChange();
                            }
                            else{
                                self._createDropdown();
                            }
                        }); 
                    }else{
                        self._createDropdown();
                    }
                }
            }

        },
        _createDropdown: function() {
            var self = this;
            S.use('brix/gallery/dropdown/', function(S, Dropdown) {
                self.dropdown = new Dropdown({
                    tmpl: self.get('el').one('.dropdown')
                });
                self._bindDropdownSizeChange();
            });
        },
        _bindDropdownSizeChange:function(){
            var self = this;
            self.dropdown.on('selected', function(ev) {
                self.setConfig({
                    index:1,
                    size: ev.text
                });
            });
        },
        _destroyDropdown: function() {
            var self = this;
            if (self.dropdown) {
                self.dropdown.destroy();
                self.dropdown = null;
            }
        },
<span id='Brix-Gallery-Pagination-method-_jumpPage'>        /**
</span>         * 跳转
         * @private
         */
        _jumpPage: function() {
            var self = this,
                pageNumNode = this.get('el').one('.page-num'),
                page = parseInt(pageNumNode.val(), 10),
                max = self.get('max'),
                index = self.get('index');
            if (isNaN(page) || page &lt; 1 || page &gt; max || page == index) {
                pageNumNode[0].select();
                return;
            }
            this.goToPage(page);
        },
<span id='Brix-Gallery-Pagination-method-_setUrlInfo'>        /**
</span>         * 设置urlInfo
         * @private
         */
        _setUrlInfo: function() {
            var self = this,
                params = self.get('params');
            if (!self.get('goToUrl')) {
                self.set('goToUrl', location.href);
            }

            var urlInfo = self.parseUrl(self.get('goToUrl'));

            //合并外部参数
            if (params) {
                S.each(params, function(v, k) {
                    /*if(urlInfo.params[k]){
                        if(!urlInfo.params[k] instanceof Array){
                            urlInfo.params[k] = [urlInfo.params[k]];
                        }
                        if(v instanceof Array){
                            S.each(v,function(d){
                                urlInfo.params[k].push(d);
                            });
                        }
                        else{
                            urlInfo.params[k].push(v);
                        }
                    }
                    else{
                        urlInfo.params[k] = v;
                    }*/
                    urlInfo.params[k] = v;
                });
            }

            self.set('urlInfo', urlInfo);
        },
<span id='Brix-Gallery-Pagination-method-_resizeConfig'>        /**
</span>         * 配置纠错，对传入的配置进行容错处理
         * @private
         */
        _resizeConfig: function() {
            var self = this,
                index = self.get('index'),
                hascount = self.get('hascount'),
                step = self.get('step'),
                size = self.get('size'),
                count = self.get('count'),
                max = self.get('max'),
                hasmax = self.get('hasmax'),
                mode = self.get('mode'),
                pageName = self.get('pageName'),
                pageSizeName = self.get('pageSizeName');

            if (!hascount) {
                if (index &gt;= step) {
                    count = size * (index + 1);
                } else {
                    count = size * step;
                }
                self.set('count', count);
            }
            if (!hasmax) {
                max = Math.ceil(count / size);
            } else {
                max = Math.min(Math.ceil(count / size), max);
            }

            self.set('max', max);
            index = Math.min(index, max);
            self.set('index', index);

            if (count === 0) {
                self.set('max', 1);
                self.set('index', 1);
            }
            step = Math.min(step, max);
            self.set('step', step);

            var formatUrl = self.doUrl();
            switch (mode) {
            case 'p':
                formatUrl = formatUrl.replace(pageName + '=' + index, pageName + '={$p}');
                break;
            case 's':
                formatUrl = formatUrl.replace(pageName + '=' + index * size, pageName + '={$p}');
                break;
            }
            self.set('formatUrl', formatUrl);
        }
    });
    S.augment(Pagination, Pagination.METHODS);
    return Pagination;
}, {
    requires: [&quot;brix/core/brick&quot;]
});</pre>
</body>
</html>
