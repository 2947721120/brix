KISSY.add("brix/gallery/searchbox/index",function(a,b,c){function h(){h.superclass.constructor.apply(this,arguments)}var d=c.all,e=a.DOM,f=a.Event,g=0;return h.ATTRS={el:{value:"#J_searchbox"},currentCls:{value:"selected"},redirect:{value:"data-redirect"},emptyAction:{value:"data-empty-action"},curItem:{value:{}},stat:{value:"data-stat-submit"},isSuggest:{value:!0},autosuggest:{value:"data-suggest-api"}},h.EVENTS={".searchbox-menu":{mouseenter:function(a){a.preventDefault();var b=this,c=b.searchObj,d=a.currentTarget;e.addClass(d,"expand"),e.height(c.menuContainer,24*c.menuItemCount+13),e.height(c.menuList,24*c.menuItemCount+10),e.addClass(c.searchboxInner,"expandmenu");var f=c.searchboxOuter;e.hasClass(f,"focus")||e.addClass(f,"focus")},mouseleave:function(a){a.preventDefault();var b=this,c=a.currentTarget;b._collapse(),b._focusInput()}},li:{click:function(a){this.tabChange(a)}},".searchbox-input":{focus:function(b){var c=this,d=b.currentTarget,f=this.searchObj.searchboxOuter;e.hasClass(f,"focus")||e.addClass(f,"focus"),e.addClass(e.prev(d),"hide");if(c.get("isSuggest")){if(c.suggest){c.detach(b.type,arguments.callee);return}var g=e.attr(c.curItem,c.get("autosuggest"));console.log(g),g&&g.indexOf("area=etao")>0&&a.use("suggest",function(){c._initSuggest(g)})}},blur:function(a){var b=a.currentTarget;b.value===""&&e.removeClass(e.prev(b),"hide");var c=this.searchObj.searchboxOuter,d=this.searchObj.menu;e.hasClass(c,"focus")&&!e.hasClass(d,"expand")&&e.removeClass(c,"focus")},keyup:function(a){var b=this;b._dealClearBtn()},keydown:function(a){a.keyCode==13&&(a.halt(!0),self.submit())}},".search-label":{click:function(a){var b=a.currentTarget;f.fire(e.next(b),"focus")}},".s-btn-clear":{click:function(a){var b=this,c=b.searchObj,d=c.input;e.val(d,""),b._hideBtn(),b._focusInput()}},".search-form":{submit:function(a){var b=this;b.submit(a)}}},h.METHODS={_focusInput:function(){var a=this,b=a.searchObj,c=b.input;c.focus()},_collapse:function(){var a=this.searchObj;e.removeClass(a.menu,"expand"),e.height(a.menuContainer,0),e.height(a.menuList,0),e.removeClass(a.searchboxInner,"expandmenu")},_dealClearBtn:function(){var a=this.searchObj.input;a.value!==""?this._showBtn():this._hideBtn()},_dealLabel:function(){var a=this.searchObj.input,b=e.prev(a);a.value===""?e.removeClass(b,"hide"):e.addClass(b,"hide")},_hideBtn:function(){var a=this.searchObj.btnClear;e.removeClass(a,"btn-show"),e.addClass(a,"btn-hide")},_showBtn:function(){var a=this.searchObj.btnClear;e.removeClass(a,"btn-hide"),e.addClass(a,"btn-show")},tabChange:function(b){var c=this,d=c.searchObj,f=b.currentTarget,g=c.get("currentCls");if(e.hasClass(f,g)){b.halt(!0);return}a.each(d.menuItems,function(a){e.removeClass(a,g)}),e.addClass(f,g),c._collapse(),e.html(d.menuSelected,e.html(e.get("a",f))+"<i></i>"),d.input.focus(),c.suggest&&(c.suggest.on("beforeStart",function(){return!1}),c.suggest=undefined),c.curItem=f;var h=a.trim(e.attr(e.get(d.menuList),c.get("redirect")))!=="false";if(!h){b.halt(!0);return}var i=e.get("a",c.curItem),j=a.trim(e.attr(i,c.get("emptyAction")));d.input.value!==""?(b.halt(!0),c.submit()):j?e.get("a",c.curItem).href=j:b.halt(!0)},submit:function(b){var c=this,d=c.searchObj,f=e.get("a",c.curItem),g=a.trim(e.attr(f,c.get("emptyAction")));if(d.input.value==="")g?(d.input.value="",c.action=g,d.searchForm.submit()):(b.halt(!0),d.input.focus());else{c.action=e.attr(f,"href"),c._parseAction(c.action);var h=e.attr(f,c.get("stat"));!a.trim(h),d.searchForm.submit()}},_parseAction:function(b){if(b.indexOf("?")!==-1){var c=b.substring(b.indexOf("?")+1,b.length).split("&");for(var d=0,e=c.length;d<e;d++){if(a.trim(c[d])==="")continue;var f=c[d].split("=");this._writeHiddenInput(this.searchObj.searchForm,f[0],f[1])}}},_writeHiddenInput:function(a,b,c){var d=a[b];return d?d.value=c:(d=e.create('<input type="hidden" name="'+b+'" value="'+c+'" />'),a.appendChild(d)),d},_initSuggest:function(b){var c=this,d=c.searchObj,f=c.get("stat");c.suggest=new a.Suggest(d.input,b,{resultFormat:"%result%",offset:0}),c.suggest.on("dataReturn",function(a){c.suggest.etaobook=a.data.etaobook,c.suggest.results=a.data.result}),c.suggest.on("beforeShow",function(){var b=c.suggest.etaobook,d="";b&&b.length>0&&(a.each(b,function(a,c){d+='<li class="ks-suggest-extra" key="'+b[c][0]+'" data-epid="'+b[c][1]+'"><span class="ks-suggest-key">'+b[c][0]+'</span><span class="suggest-star">\u2605</span><span class="suggest-author">'+b[c][2]+'</span><span class="suggest-pub">'+b[c][3]+'</span><span class="suggest-time">'+b[c][4]+"</span></li>"}),c.suggest.results.length===0&&e.html(c.suggest.content,"<ol></ol>"),d&&e.append(e.create(d),c.suggest.content.firstChild)),c._keyword()}),c.suggest.on("itemSelect",function(){var b=this.selectedItem,g=e.query("li",this.containers),h={};h.q=this.query,h.wq=e.attr(b,"key"),h.n=a.indexOf(b,g);var i=e.get("a",c.curItem);e.attr(i,f,e.attr(i,f)+"&"+a.param(h));var j=e.attr(b,"data-epid");j&&(c._writeHiddenInput(d.searchForm,"epid",j),c._writeHiddenInput(d.searchForm,"v","product"),c._writeHiddenInput(d.searchForm,"p","detail"))})},_keyword:function(){var b=this,c=b.suggest,d=c.query,f=d.length;a.each(e.query("li",c.content),function(a){var b=e.get(".ks-suggest-key",a),c=e.html(b);c.indexOf(d)===0&&e.html(b,c.substring(0,f)+"<b>"+c.substring(f,c.length)+"</b>")})}},a.extend(h,b,{initialize:function(){var a=this,b=e.get(a.get("el")),c=e.get(".searchbox-menu",b),d=e.get(".searchbox-input",b),f=e.query("li",c);a.searchObj={searchbox:b,searchForm:e.get("form",b),menu:c,menuSelected:e.get(".s-menu-selected",c),menuContainer:e.get(".s-menu-container",c),menuList:e.get(".s-menu-list",c),menuItems:f,searchboxOuter:e.get(".searchbox-outer",b),searchboxInner:e.get(".searchbox-inner",b),input:d,btnClear:e.get(".s-btn-clear",b),menuItemCount:e.query("li",c).length},a.curItem=e.filter(f,"."+a.get("currentCls"))[0],a._dealClearBtn();var g="autofocus"in document.createElement("input"),h=e.attr(d,"data-autofocus"),i=h=="autofocus"||h==!0;(!g||!i)&&a._dealLabel(),i&&d.focus()},destructor:function(){}}),a.augment(h,h.METHODS),h},{requires:["brix/core/brick","node"]});