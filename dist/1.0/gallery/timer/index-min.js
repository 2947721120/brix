KISSY.add("brix/gallery/timer/index",function(t,e,n){function r(){r.superclass.constructor.apply(this,arguments)}return r.ATTRS={mode:{value:"down"},updateTime:{value:1e4},units:{value:"s"},isServer:{value:!1},ajusted:{value:!1},ajustInterval:{value:5e3},interval:{value:100},data:{valueFn:function(){return this._getUnitsData(0)}}},r.FIRES={notify:"notify"},r.getServerTime=function(e,r){if(r){var a=window.location.protocol+"//"+window.location.host+"?t="+ +new Date;n({type:"head",url:a,success:function(t,n,r){var a=new Date(r.getResponseHeader("Date")).getTime();e(a)}})}else e(t.now())},t.extend(r,e,{initialize:function(){var t=this;r.getServerTime(function(e){t._start(e)},t.get("isServer"))},_start:function(e){var n,r=this,a=r.get("mode"),i=r.get("interval"),o=r.get("ajustInterval"),s=r.get("updateTime");switch(a){case"up":n=e-s;break;case"down":n=s}r._currentTime=n,r._startCurrentTime=n,r._startBaseTime=e,r._diffTime=0,r._timerHandler=t.later(r._timerInterval,i,!1,r,[i,a]),r.get("ajusted")&&(r._ajustHandler=t.later(r._ajustInterval,o,!1,r,[o,a]))},_ajustInterval:function(e,n){var a=this;r.getServerTime(function(r){switch(a._diffTime=r-a._startBaseTime,n){case"up":a._diffTime-=a._currentTime-a._startCurrentTime;break;case"down":a._diffTime-=a._startCurrentTime-a._currentTime}if(a._diffTime>500){switch(n){case"up":a._currentTime+=a._diffTime;break;case"down":a._currentTime-=a._diffTime,0>=a._currentTime&&(a._currentTime=interval)}a._diffTime=0}a._ajustHandler=t.later(a._ajustInterval,e,!1,a,[e,n])},a.get("isServer"))},_timerInterval:function(e,n){var a=this,i=a._currentTime;switch(n){case"up":i+=e;break;case"down":i-=e}a._currentTime=i;var o=a._getUnitsData(i);return t.each(o,function(t,e){a.setChunkData(e,t)}),0>=i?(a._ajustHandler&&a._ajustHandler.cancel(),a.fire(r.FIRES.notify),void 0):(a._timerHandler=t.later(a._timerInterval,e,!1,a,[e,n]),void 0)},_getUnitsData:function(e){var n=this,r={};switch(n.get("units")){case"y":r={y:Math.floor(e/31536e6),M:Math.floor(e/2592e6)%12,d:Math.floor(e/864e5)%30,h:Math.floor(e/36e5)%24,m:Math.floor(e/6e4)%60,s:Math.floor(e/1e3)%60,hs:Math.floor(e/100)%10};break;case"M":r={M:Math.floor(e/2592e6),d:Math.floor(e/864e5)%30,h:Math.floor(e/36e5)%24,m:Math.floor(e/6e4)%60,s:Math.floor(e/1e3)%60,hs:Math.floor(e/100)%10};break;case"d":r={d:Math.floor(e/864e5),h:Math.floor(e/36e5)%24,m:Math.floor(e/6e4)%60,s:Math.floor(e/1e3)%60,hs:Math.floor(e/100)%10};break;case"h":r={h:Math.floor(e/36e5),m:Math.floor(e/6e4)%60,s:Math.floor(e/1e3)%60,hs:Math.floor(e/100)%10};break;case"m":var r={m:Math.floor(e/6e4),s:Math.floor(e/1e3)%60,hs:Math.floor(e/100)%10};break;case"s":r={s:Math.floor(e/1e3),hs:Math.floor(e/100)%10};break;case"hs":r={hs:Math.floor(e/100)}}return t.each(r,function(e,n){t.inArray(n,["h","m","s"])&&10>e&&(r[n]=""+("0"+e)),r[n]=""+r[n]}),n.get("interval")>=1e3&&delete r.hs,r},destructor:function(){this._ajustHandler&&(this._ajustHandler.cancel(),this._ajustHandler=null),this._timerHandler&&(this._timerHandler.cancel(),this._timerHandler=null)}}),r},{requires:["brix/core/brick","ajax"]});