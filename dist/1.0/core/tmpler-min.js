KISSY.add("brix/core/tmpler",function(a,b,c){function e(a,b){a&&b!==!1?(this.tmpls=[],this._praseTmpl(a,b)):this.tmpl=a}var d=c.all;return a.extend(e,Object,{_praseTmpl:function(b,c){var e=this,f=!1,g,h;if(typeof b=="string"){if(b.charAt(0)==="."||b.charAt(0)==="#"||b==="body")g=d(b)}else g=b;g&&(g.item(0)[0].nodeName.toUpperCase()=="SCRIPT"?b=g.item(0).html():f=!0);if(!f){var i="<([\\w]+)\\s+[^>]*?bx-tmpl=[\"']?([^\"'\\s]+)[\"']?\\s+[^>]*?bx-datakey=[\"']?([^\"'\\s]+)[\"']?[^>]*?>(@brix@)</\\1>";while(c--)i=i.replace("@brix@","(?:<\\1[^>]*>@brix@</\\1>|[\\s\\S])*?");i=i.replace("@brix@","(?:[\\s\\S]*?)"),e.reg=i,a.log(i),e.tmpl=e._replaceTmpl(b),e._buildTmpls(e.tmpl)}e.inDom=f},_buildTmpls:function(a){var b=this,c=new RegExp(b.reg,"ig");while((m=c.exec(a))!==null)b.tmpls.push({name:m[2],datakey:m[3],tmpler:new e(m[4],!1)}),b._buildTmpls(m[4])},_replaceTmpl:function(a){var b=/<!--bx-tmpl="([^"]+?)"\s+bx-datakey="([^"]+?)"-->(\s*([\s\S]*)?\s*)<!--bx-tmpl="\1"-->/g,c;while(b.test(a))a=a.replace(b,function(a,b,c,d){return d}),b.lastIndex=0;return a},addTmpl:function(a,b,c){var d=this;d.tmpls.push({id:a,datakey:b,tmpler:new e(c,!1)})},getTmpl:function(){return this.tmpl},to_html:function(a){return b.to_html(this.getTmpl(),a)}}),e},{requires:["./mu","node","sizzle"]});