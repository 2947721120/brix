KISSY.add("brix/core/tmpler",function(e,t,n){function r(e,t){this.tmpls=[],e&&t!==!1?this._praseTmpl(e,t):this.tmpl=e}var a=n.all;return e.extend(r,Object,{_praseTmpl:function(e,t){var n,r=this,i=!1;if("string"==typeof e?("."===e.charAt(0)||"#"===e.charAt(0)||"body"===e)&&(n=a(e)):n=e,n&&("SCRIPT"==n.item(0)[0].nodeName.toUpperCase()?e=n.item(0).html():i=!0),!i){for(var o="<([\\w]+)\\s+[^>]*?bx-tmpl=[\"']?([^\"'\\s]+)[\"']?\\s+[^>]*?bx-datakey=[\"']?([^\"'\\s]+)[\"']?[^>]*?>(@brix@)</\\1>";t--;)o=o.replace("@brix@","(?:<\\1[^>]*>@brix@</\\1>|[\\s\\S])*?");o=o.replace("@brix@","(?:[\\s\\S]*?)"),r.reg=o,r.tmpl=r._replaceTmpl(e),r._buildTmpls(r.tmpl)}r.inDom=i},_buildTmpls:function(e){for(var t,n=this,a=RegExp(n.reg,"ig");null!==(t=a.exec(e));)n.tmpls.push({name:t[2],datakey:t[3],tmpler:new r(t[4],!1)}),n._buildTmpls(t[4])},_replaceTmpl:function(t){for(var n=/<!--bx-tmpl="([^"]+?)"\s+bx-datakey="([^"]+?)"-->(\s*([\s\S]*)?\s*)<!--bx-tmpl="\1"-->/g,r=function(t,n,r,a){return e.log(t+","+a),a};n.test(t);)t=t.replace(n,r),n.lastIndex=0;return t},addTmpl:function(e,t,n){var a=this;a.tmpls.push({name:e,datakey:t,tmpler:new r(n,!1)})},getTmpl:function(){return this.tmpl},to_html:function(e){return t.to_html(this.getTmpl(),e)}}),r},{requires:["./mu","node","sizzle"]});