KISSY.add("brix/core/tmpler",function(a,b,c){function e(a,b){this.tmpls=[],a&&b!==!1?this._praseTmpl(a,b):this.tmpl=a}var d=c.all;return a.extend(e,Object,{_praseTmpl:function(a,b){var c=this,e=!1,f,g;if(typeof a=="string"){if(a.charAt(0)==="."||a.charAt(0)==="#"||a==="body")f=d(a)}else f=a;f&&(f.item(0)[0].nodeName.toUpperCase()=="SCRIPT"?a=f.item(0).html():e=!0);if(!e){var h="<([\\w]+)\\s+[^>]*?bx-tmpl=[\"']?([^\"'\\s]+)[\"']?\\s+[^>]*?bx-datakey=[\"']?([^\"'\\s]+)[\"']?[^>]*?>(@brix@)</\\1>";while(b--)h=h.replace("@brix@","(?:<\\1[^>]*>@brix@</\\1>|[\\s\\S])*?");h=h.replace("@brix@","(?:[\\s\\S]*?)"),c.reg=h,c.tmpl=c._replaceTmpl(a),c._buildTmpls(c.tmpl)}c.inDom=e},_buildTmpls:function(a){var b=this,c=new RegExp(b.reg,"ig");while((m=c.exec(a))!==null)b.tmpls.push({name:m[2],datakey:m[3],tmpler:new e(m[4],!1)}),b._buildTmpls(m[4])},_replaceTmpl:function(a){var b=/<!--bx-tmpl="([^"]+?)"\s+bx-datakey="([^"]+?)"-->(\s*([\s\S]*)?\s*)<!--bx-tmpl="\1"-->/g,c;while(b.test(a))a=a.replace(b,function(a,b,c,d){return d}),b.lastIndex=0;return a},addTmpl:function(a,b,c){var d=this;d.tmpls.push({id:a,datakey:b,tmpler:new e(c,!1)})},getTmpl:function(){return this.tmpl},to_html:function(a){return b.to_html(this.getTmpl(),a)}}),e},{requires:["./mu","node","sizzle"]});