KISSY.add("brix/core/pagelet",function(S,Chunk){function _stamp(a,b){return b=b||"brick_",a.attr("id")||a.attr("id",S.guid("brix_"+b)),a.attr("id")}function Pagelet(){Pagelet.superclass.constructor.apply(this,arguments);var a=this;a.isReady=!1,a.readyList=[],a.bricks=[],a.isAddBehavior=!1;if(a.get("autoRender")||a.get("tmpler").inDom)a.on("rendered",function(){var b=a.get("callback");b&&typeof b=="function"&&a.ready(b),a.get("behavior")&&a.addBehavior()}),a.render()}return Pagelet.ATTRS={behavior:{value:!0},callback:{value:null}},S.extend(Pagelet,Chunk,{getBrick:function(a){var b=this,c;return S.each(b.bricks,function(b){if(b.id===a)return c=b.brick,!1}),c||null},addBehavior:function(){var a=this;if(a.get("rendered")&&!a.isAddBehavior){a.isAddBehavior=!0;var b=a.get("el"),c=b.all("[bx-name]");b.hasAttr("bx-name")&&(c=b.add(c)),a._addBehavior(c,function(b){a.bricks=b,a._fireReady(),a.on("beforeRefreshTmpl",function(b){b.node.all("[bx-name]").each(function(b){a.destroy(b.attr("id"))})}),a.on("afterRefreshTmpl",function(b){a._addBehavior(b.node.all("[bx-name]"),function(b){b.length>0&&(a.bricks=a.bricks.concat(b))})})})}},_addBehavior:function(brickNodes,fn){var self=this,bricks=[];brickNodes.each(function(brickNode){var id=_stamp(brickNode),name=brickNode.attr("bx-name"),path=brickNode.attr("bx-path"),config=brickNode.attr("bx-config");config=config?eval("config="+config):{},bricks.push({id:id,name:name,path:path,config:config})});if(bricks.length>0){var useList=[];S.each(bricks,function(a){a.path||(a.path="brix/gallery/"+a.name+"/"),S.inArray(useList,a.path)||useList.push(a.path)}),S.use(useList.join(","),function(a){var b=arguments;a.each(bricks,function(c){var d=c.id,e=a.merge({container:"#"+d,id:d,el:"#"+d,pagelet:self},c.config),f=b[a.indexOf(c.path,useList)+1],g=new f(e);c.brick=g}),b=null,fn(bricks)})}else fn(bricks)},ready:function(a){this.isReady?a.call(window,this):this.readyList.push(a)},_fireReady:function(){var a=this;if(a.isReady)return;a.isReady=!0;if(a.readyList){var b,c=0;while(b=a.readyList[c++])b.call(a);a.readyList=null}},destroy:function(a){var b=this,c=b.get("tmpler");if(a)for(var d=0;d<b.bricks.length;d++){var e=b.bricks[d];if(a===e.id)return b._destroyBrick(e),b.bricks.splice(d,1),!1}else{S.each(b.bricks,function(a,c){b._destroyBrick(a),b.bricks=null}),c&&(c.tmpls=null);if(b.get("rendered")){var f=b.get("el");b.get("isRemoveEl")?f.remove():f.empty(),f=null}b.detach()}},_destroyBrick:function(a){a.brick&&(a.brick.destroy(),a.brick=null)}}),Pagelet},{requires:["./chunk"]});