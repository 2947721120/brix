KISSY.add("brix/core/chunk",function(e,t,n,r,a,i){function l(){l.superclass.constructor.apply(this,arguments);var e=this,t=e.get("tmpl");if(t){e._buildTmpler(t,e.get("level"));var n=e.get("tmpler");n&&(e._buildDataset(e.get("data")),n.inDom&&e.set("el",t))}}var o=t.all;return l.ATTRS={el:{getter:function(t){return e.isString(t)&&(t=o(t)),t}},isRemoveHTML:{value:!0},isRemoveEl:{value:!0},container:{value:"body",getter:function(t){return e.isString(t)&&(t=o(t)),t}},tmpl:{value:!1},tmpler:{value:!1},rendered:{value:!1},autoRender:{value:!0},data:{value:!1},dataset:{value:!1},level:{value:3},renderType:{value:"html"}},e.extend(l,r,{_buildTmpler:function(e,t){var n=this;if(!n.get("isBuidTmpler")){n.set("isBuidTmpler",!0);var r=new i(e,t);n.set("tmpler",r)}},_buildDataset:function(t){var n=this;if(!n.get("isBuidDataset")){n.set("isBuidDataset",!0),t=t||{},t=e.clone(t);var r=new a({data:t});n.set("dataset",r),r.on("afterDataChange",function(e){n._render(e.subAttrName,e.newVal)})}},_destroy:function(){var e=this,t=e.get("tmpler"),n=e.get("dataset");t&&(e.set("tmpler",null),delete t.tmpls),n&&(e.set("dataset",null),n.detach())},addTmpl:function(e,t,n){var r=this;r._buildTmpler("",!1),r._buildDataset();var a=r.get("tmpler");a.addTmpl(e,t,n)},setChunkData:function(t,n,r){var a=this,i=a.get("dataset");if(i){n=e.clone(n);var l="html";r&&r.renderType&&(l=r.renderType,delete r.renderType),a.set("renderType",l),i.set("data."+t,n,r)}},render:function(){var e=this;if(!e.get("rendered")){var t=e.get("dataset");t&&e._render("data",t.get("data")),e.set("rendered",!0),e.fire("rendered")}},_render:function(r,a){var i=this,l=i.get("tmpler");if(l)if(r.split(".").length>1)i.get("rendered")&&(r=r.replace(/^data\./,""),i._renderTmpl(l.tmpls,r,a));else if(!l.inDom){var u,s=i.get("container"),c=i.get("el"),f=e.trim(l.to_html(a));if(c&&0!==c.length)if(8>=n.ie){for(u=new t("<div />"),s.append(u),u.html(f);u[0].childNodes.length>0;)s[0].appendChild(u[0].childNodes[0]);u.remove(),u=null}else s.append(f);else{var p="brix_"+e.guid();if(8>=n.ie){u=new t("<div />"),s.append(u),u.html(f);var d=u[0].childNodes;if(d.length>1)u.attr("id",p);else{for(p=d[0].id||p,d[0].id=p;d.length>0;)s[0].appendChild(d[0]);u.remove(),u=null}}else u=new t(f),u.length>1?u=o('<div id="'+p+'"></div>').append(u):(p=u.attr("id")||p,u.attr("id",p)),s.append(u);i.set("el","#"+p)}}},_renderTmpl:function(t,n,r){var a=this,i=a.get("el");e.each(t,function(t){if((","+t.datakey+",").indexOf(","+n+",")>=0){var l=i.all("[bx-tmpl="+t.name+"]");i.attr("bx-tmpl")==t.name&&(l=i.add(l)),l.each(function(n){if(n.attr("bx-datakey")==t.datakey){var i={};e.each(t.datakey.split(","),function(e){for(var t=r,n=e.split("."),a=n.length,l=0;l!==a;)t=t[n[l]],l++;i[n[a-1]]=t,t=null}),e.each(r,function(t,n){e.isFunction(t)&&(i[n]=t)});var l=a.get("renderType")||"html";a.fire("beforeRefreshTmpl",{node:n,renderType:l}),n[l](e.trim(t.tmpler.to_html(i))),a.fire("afterRefreshTmpl",{node:n}),i=null}}),l=null}})}}),l},{requires:["node","ua","base","./dataset","./tmpler"]});