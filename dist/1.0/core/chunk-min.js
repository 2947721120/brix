KISSY.add("brix/core/chunk",function(a,b,c,d,e,f){function h(){h.superclass.constructor.apply(this,arguments);var a=this,b=a.get("tmpl");if(b){a._buildTmpler(b,a.get("level"));var c=a.get("tmpler");c&&(a._buildDataset(a.get("data")),c.inDom&&a.set("el",b))}}var g=b.all;return h.ATTRS={el:{getter:function(b){return a.isString(b)&&(b=g(b)),b}},isRemoveHTML:{value:!0},isRemoveEl:{value:!0},container:{value:"body",getter:function(b){return a.isString(b)&&(b=g(b)),b}},tmpl:{value:!1},tmpler:{value:!1},rendered:{value:!1},autoRender:{value:!0},data:{value:!1},dataset:{value:!1},level:{value:3}},a.extend(h,d,{_buildTmpler:function(a,b){var c=this;if(!c.get("isBuidTmpler")){c.set("isBuidTmpler",!0);var d=new f(a,b);c.set("tmpler",d)}},_buildDataset:function(b){var c=this;c.get("isBuidDataset")||(c.set("isBuidDataset",!0),b=b||{},b=a.clone(b),dataset=new e({data:b}),c.set("dataset",dataset),dataset.on("afterDataChange",function(a){c._render(a.subAttrName,a.newVal)}))},_destroy:function(){var a=this,b=a.get("tmpler"),c=a.get("dataset");b&&(a.set("tmpler",null),delete b.tmpls),c&&(a.set("dataset",null),c.detach())},addTmpl:function(a,b,c){var d=this;d._buildTmpler("",!1),d._buildDataset();var e=d.get("tmpler");e.addTmpl(a,b,c)},setChunkData:function(b,c,d){var e=this,f=e.get("dataset");f&&(c=a.clone(c),f.set("data."+b,c,d))},render:function(){var a=this;if(!a.get("rendered")){var b=a.get("dataset");b&&a._render("data",b.get("data")),a.set("rendered",!0),a.fire("rendered")}},_render:function(d,e){var f=this,h=f.get("tmpler");if(h)if(d.split(".").length>1)f.get("rendered")&&(d=d.replace(/^data\./,""),f._renderTmpl(h.tmpls,d,e));else if(!h.inDom){var i=f.get("container"),j=f.get("el"),k=h.to_html(e);if(!j||j.length==0){var l="brix_"+a.guid();if(c.ie<=8){var m=new b("<div />");i.append(m),m.html(k);var n=m[0].childNodes;if(n.length>1)m.attr("id",l);else{l=n[0].id||l,n[0].id=l;while(n.length>0)i[0].appendChild(n[0]);m.remove()}}else{var m=new b(k);m.length>1?m=g('<div id="'+l+'"></div>').append(m):(l=m.attr("id")||l,m.attr("id",l)),i.append(m)}f.set("el","#"+l)}else if(c.ie<=8){var m=new b("<div />");i.append(m),m.html(k);while(m[0].childNodes.length>0)i[0].appendChild(m[0].childNodes[0]);m.remove()}else i.append(k)}},_renderTmpl:function(b,c,d){var e=this,f=e.get("el");a.each(b,function(b){if((","+b.datakey+",").indexOf(","+c+",")>=0){var g=f.all("[bx-tmpl="+b.name+"]");f.attr("bx-tmpl")==b.name&&(g=f.add(g)),g.each(function(c){if(c.attr("bx-datakey")==b.datakey){var f={};a.each(b.datakey.split(","),function(a){var b=d,c=a.split("."),e=c.length,g=0;while(g!==e)b=b[c[g]],g++;f[c[e-1]]=b,b=null}),a.each(d,function(b,c){a.isFunction(b)&&(f[c]=b)}),e.fire("beforeRefreshTmpl",{node:c}),c.html(b.tmpler.to_html(f)),e.fire("afterRefreshTmpl",{node:c}),f=null}}),g=null}})}}),h},{requires:["node","ua","base","./dataset","./tmpler"]});