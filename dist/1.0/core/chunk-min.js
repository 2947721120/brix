KISSY.add("brix/core/chunk",function(e,t,r,n,a,i){function l(e,t){for(var r=0;e.length>r;r++)for(var n=0;t.length>n;n++)if(e[r]==t[n])return!0;return!1}function o(){o.superclass.constructor.apply(this,arguments);var e=this,t=e.get("tmpl");if(t){e._buildTmpler(t,e.get("level"));var r=e.get("tmpler");r&&(e._buildDataset(e.get("data")),r.inDom&&e.set("el",t))}}var u=t.all;return o.ATTRS={el:{getter:function(t){return e.isString(t)&&(t=u(t)),t}},isRemoveHTML:{value:!0},isRemoveEl:{value:!0},container:{value:"body",getter:function(t){return e.isString(t)&&(t=u(t)),t}},tmpl:{value:!1},tmpler:{value:!1},rendered:{value:!1},autoRender:{value:!0},data:{value:!1},dataset:{value:!1},level:{value:3}},e.extend(o,n,{_buildTmpler:function(e,t){var r=this;if(!r.get("isBuidTmpler")){r.set("isBuidTmpler",!0);var n=new i(e,t);r.set("tmpler",n)}},_buildDataset:function(t){var r=this;if(!r.get("isBuidDataset")){r.set("isBuidDataset",!0),t=t||{},t=e.clone(t);var n=new a({data:t});r.set("dataset",n),n.on("*Change",function(t){var a=!1,i=e.map(t.subAttrName,function(e){return/^data\./g.test(e)?(a=!0,e.replace(/^data\./,"")):"zuomo.xb@taobao.com"});a&&r._renderTmpl(i,n.get("data"))})}},_destroy:function(){var e=this,t=e.get("tmpler"),r=e.get("dataset");t&&(e.set("tmpler",null),delete t.tmpls),r&&(e.set("dataset",null),r.detach())},addTmpl:function(e,t,r){var n=this;n._buildTmpler("",!1),n._buildDataset();var a=n.get("tmpler");a.addTmpl(e,t,r)},setChunkData:function(t,r,n){var a=this,i=a.get("dataset");if(i){if(e.isObject(t)){t=e.clone(t);var l={};for(var o in t)l["data."+o]=t[o];t=l,n=r}else t="data."+t,r=e.clone(r);var u="html";n&&n.renderType&&(u=n.renderType,delete n.renderType),a.set("renderType",u),i.set.apply(i,arguments)}},render:function(){var e=this;if(!e.get("rendered")){var t=e.get("dataset");t&&e._render("data",t.get("data")),e.set("rendered",!0),e.fire("rendered")}},_render:function(n,a){var i=this,l=i.get("tmpler");if(l&&!l.inDom){var o,s=i.get("container"),c=i.get("el"),f=e.trim(l.to_html(a));if(c&&0!==c.length)if(8>=r.ie){for(o=new t("<div />"),s.append(o),o.html(f);o[0].childNodes.length>0;)s[0].appendChild(o[0].childNodes[0]);o.remove(),o=null}else s.append(f);else{var p="brix_"+e.guid();if(8>=r.ie){o=new t("<div />"),s.append(o),o.html(f);var d=o[0].childNodes;if(d.length>1)o.attr("id",p);else{for(p=d[0].id||p,d[0].id=p;d.length>0;)s[0].appendChild(d[0]);o.remove(),o=null}}else o=new t(f),o.length>1?o=u('<div id="'+p+'"></div>').append(o):(p=o.attr("id")||p,o.attr("id",p)),s.append(o);i.set("el","#"+p)}}},_renderTmpl:function(t,r){var n=this,a=n.get("tmpler");if(a&&n.get("rendered")){var i=n.get("el"),o=a.tmpls;e.each(o,function(a){var o=a.datakey.split(",");if(l(o,t)){var u=i.all("[bx-tmpl="+a.name+"]");i.attr("bx-tmpl")==a.name&&(u=i.add(u)),u.each(function(t){if(t.attr("bx-datakey")==a.datakey){var i={};e.each(o,function(e){for(var t=r,n=e.split("."),a=n.length,l=0;l!==a;)t=t[n[l]],l++;i[n[a-1]]=t,t=null}),e.each(r,function(t,r){e.isFunction(t)&&(i[r]=t)});var l=n.get("renderType")||"html";n.fire("beforeRefreshTmpl",{node:t,renderType:l}),t[l](e.trim(a.tmpler.to_html(i))),n.fire("afterRefreshTmpl",{node:t}),i=null}}),u=null}})}}}),o},{requires:["node","ua","base","./dataset","./tmpler"]});