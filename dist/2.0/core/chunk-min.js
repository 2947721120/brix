KISSY.add("brix/core/chunk",function(e,t,n,r,a,i){function l(e,t){for(var n=0;e.length>n;n++)for(var r=0;t.length>r;r++)if(e[n]==t[r])return!0;return!1}var o=t.all,u=e.noop,c=r.extend({constructor:function c(){var e=this;c.superclass.constructor.apply(e,arguments);var t=e.get("tmpler");(e.get("autoRender")||!t||t.inDom)&&e.render()},bindInternal:u,syncInternal:u,initializer:function(){var e=this,t=e.get("tmpl");if(t){e._bx_buildTmpler(t,e.get("level"));var n=e.get("tmpler");n&&(e._bx_buildDataset(e.get("data")),n.inDom&&e.set("el",t))}},_bx_buildTmpler:function(e,t){var n=this;if(!n.get("isBuidTmpler")){n.set("isBuidTmpler",!0);var r=new i(e,t);n.set("tmpler",r)}},_bx_buildDataset:function(t){var n=this;if(!n.get("isBuidDataset")){n.set("isBuidDataset",!0),t=e.clone(t||{});var r=new a({data:t});n.set("dataset",r),r.on("*Change",function(t){var a=!1,i=e.map(t.subAttrName,function(e){return/^data\./g.test(e)?(a=!0,e.replace(/^data\./,"")):"zuomo.xb@taobao.com"});a&&n._bx_renderTmpl(i,r.get("data"))})}},destructor:function(){var e=this,t=e.get("tmpler"),n=e.get("dataset");t&&(e.set("tmpler",null),delete t.tmpls),n&&(e.set("dataset",null),n.detach())},bindUI:u,syncUI:u,addTmpl:function(e,t,n){var r=this;if(r._bx_buildTmpler("",!1),r._bx_buildDataset(),e){var a=r.get("tmpler");a.addTmpl(e,t,n)}},setChunkData:function(t,n,r){var a=this,i=a.get("dataset");if(i){if(e.isObject(t)){t=e.clone(t);var l={};for(var o in t)l["data."+o]=t[o];t=l,r=n}else t="data."+t,n=e.clone(n);var u="html";r&&r.renderType&&(u=r.renderType,delete r.renderType),a.set("renderType",u),i.set.apply(i,arguments)}},render:function(){var e=this;if(!e.get("rendered")){e.fire("beforeRenderUI");var t=e.get("dataset");t&&e._bx_render(t.get("data")),e.fire("afterRenderUI"),e.setInternal("rendered",!0),e.fire("beforeBindUI"),c.superclass.bindInternal.call(e),e.callMethodByHierarchy("bindUI","__bindUI"),e.callMethodByHierarchy("initialize","constructor"),e.fire("afterBindUI"),e.fire("beforeSyncUI"),c.superclass.syncInternal.call(e),e.callMethodByHierarchy("syncUI","__syncUI"),e.fire("afterSyncUI")}return e},_bx_render:function(r){var a=this,i=a.get("tmpler");if(i&&!i.inDom){var l,u=a.get("container"),c=a.get("el"),s=e.trim(i.render(r));if(c&&0!==c.length)if(8>=n.ie){for(l=new t("<div />"),u.append(l),l.html(s);l[0].childNodes.length>0;)u[0].appendChild(l[0].childNodes[0]);l.remove(),l=null}else u.append(s);else{var f="brix_"+e.guid();if(8>=n.ie){l=new t("<div />"),u.append(l),l.html(s);var p=l[0].childNodes;if(p.length>1)l.attr("id",f);else{for(f=p[0].id||f,p[0].id=f;p.length>0;)u[0].appendChild(p[0]);l.remove(),l=null}}else l=new t(s),l.length>1?l=o('<div id="'+f+'"></div>').append(l):(f=l.attr("id")||f,l.attr("id",f)),u.append(l);a.set("el","#"+f)}}},_bx_renderTmpl:function(t,n){var r=this,a=r.get("tmpler");if(a&&r.get("rendered")){var i=r.get("el"),o=a.tmpls;e.each(o,function(a){var o=a.datakey.split(",");if(l(o,t)){var u=i.all("[bx-tmpl="+a.name+"]");i.attr("bx-tmpl")==a.name&&(u=i.add(u)),u.each(function(t){if(t.attr("bx-datakey")==a.datakey){var i={};e.each(o,function(e){for(var t=n,r=e.split("."),a=r.length,l=0;l!==a;)t=t[r[l]],l++;i[r[a-1]]=t,t=null}),e.each(n,function(t,n){e.isFunction(t)&&(i[n]=t)});var l=r.get("renderType")||"html";r.fire("beforeRefreshTmpl",{node:t,renderType:l}),t[l](e.trim(a.tmpler.render(i))),r.fire("afterRefreshTmpl",{node:t}),i=null}}),u=null}})}}},{ATTRS:{el:{getter:function(t){return e.isString(t)&&(t=o(t)),t}},destroyAction:{value:"remove"},container:{value:"body",getter:function(t){return e.isString(t)&&(t=o(t)),t}},tmpl:{value:!1},tmpler:{value:!1},rendered:{value:!1},autoRender:{value:!0},data:{value:!1},dataset:{value:!1},level:{value:3}}});return c},{requires:["node","ua","rich-base","./dataset","./tmpler"]});