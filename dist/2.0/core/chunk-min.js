KISSY.add("brix/core/chunk",function(e,t,n,r,a,i){var l=t.all,o=e.noop,c=r.extend({constructor:function c(){var e=this;c.superclass.constructor.apply(e,arguments);var t=e.get("tmpler");(e.get("autoRender")||!t||t.inDom)&&e.render()},bindInternal:o,syncInternal:o,initializer:function(){var e=this,t=e.get("tmpl");if(t){e._bx_buildTmpler(t,e.get("level"));var n=e.get("tmpler");n&&(e._bx_buildDataset(e.get("data")),n.inDom&&e.set("el",t))}},_bx_buildTmpler:function(e,t){var n=this;if(!n.get("isBuidTmpler")){n.set("isBuidTmpler",!0);var r=new i(e,t);n.set("tmpler",r)}},_bx_buildDataset:function(t){var n=this;if(!n.get("isBuidDataset")){n.set("isBuidDataset",!0),t=t||{},t=e.clone(t);var r=new a({data:t});n.set("dataset",r),r.on("afterDataChange",function(e){n._bx_render(e.subAttrName,e.newVal)})}},destructor:function(){var e=this,t=e.get("tmpler"),n=e.get("dataset");t&&(e.set("tmpler",null),delete t.tmpls),n&&(e.set("dataset",null),n.detach())},bindUI:o,syncUI:o,addTmpl:function(e,t,n){var r=this;if(r._bx_buildTmpler("",!1),r._bx_buildDataset(),e){var a=r.get("tmpler");a.addTmpl(e,t,n)}},setChunkData:function(t,n,r){var a=this,i=a.get("dataset");i&&(n=e.clone(n),i.set("data."+t,n,r))},render:function(){var e=this;if(!e.get("rendered")){e.fire("beforeRenderUI");var t=e.get("dataset");t&&e._bx_render("data",t.get("data")),e.fire("afterRenderUI"),e.setInternal("rendered",!0),e.fire("beforeBindUI"),c.superclass.bindInternal.call(e),e.callMethodByHierarchy("bindUI","__bindUI"),e.callMethodByHierarchy("initialize","constructor"),e.fire("afterBindUI"),e.fire("beforeSyncUI"),c.superclass.syncInternal.call(e),e.callMethodByHierarchy("syncUI","__syncUI"),e.fire("afterSyncUI")}return e},_bx_render:function(r,a){var i=this,o=i.get("tmpler");if(o)if(r.split(".").length>1)i.get("rendered")&&(r=r.replace(/^data\./,""),i._bx_renderTmpl(o.tmpls,r,a));else if(!o.inDom){var c,u=i.get("container"),s=i.get("el"),f=e.trim(o.render(a));if(s&&0!==s.length)if(8>=n.ie){for(c=new t("<div />"),u.append(c),c.html(f);c[0].childNodes.length>0;)u[0].appendChild(c[0].childNodes[0]);c.remove(),c=null}else u.append(f);else{var p="brix_"+e.guid();if(8>=n.ie){c=new t("<div />"),u.append(c),c.html(f);var d=c[0].childNodes;if(d.length>1)c.attr("id",p);else{for(p=d[0].id||p,d[0].id=p;d.length>0;)u[0].appendChild(d[0]);c.remove(),c=null}}else c=new t(f),c.length>1?c=l('<div id="'+p+'"></div>').append(c):(p=c.attr("id")||p,c.attr("id",p)),u.append(c);i.set("el","#"+p)}}},_bx_renderTmpl:function(t,n,r){var a=this,i=a.get("el");e.each(t,function(t){if((","+t.datakey+",").indexOf(","+n+",")>=0){var l=i.all("[bx-tmpl="+t.name+"]");i.attr("bx-tmpl")==t.name&&(l=i.add(l)),l.each(function(n){if(n.attr("bx-datakey")==t.datakey){var i={};e.each(t.datakey.split(","),function(e){for(var t=r,n=e.split("."),a=n.length,l=0;l!==a;)t=t[n[l]],l++;i[n[a-1]]=t,t=null}),e.each(r,function(t,n){e.isFunction(t)&&(i[n]=t)}),a.fire("beforeRefreshTmpl",{node:n}),n.html(e.trim(t.tmpler.render(i))),a.fire("afterRefreshTmpl",{node:n}),i=null}}),l=null}})}},{ATTRS:{el:{getter:function(t){return e.isString(t)&&(t=l(t)),t}},destroyAction:{value:"remove"},container:{value:"body",getter:function(t){return e.isString(t)&&(t=l(t)),t}},tmpl:{value:!1},tmpler:{value:!1},rendered:{value:!1},autoRender:{value:!0},data:{value:!1},dataset:{value:!1},level:{value:3}}});return c},{requires:["node","ua","rich-base","./dataset","./tmpler"]});