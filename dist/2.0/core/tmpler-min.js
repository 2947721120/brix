KISSY.add("brix/core/tmpler",function(e,t,n,r){function i(e,t){e&&(t!==!1?(this.subTmpls=[],this.storeTmpls={},this._bx_praseTmpl(e,t)):this.tmpl=e)}var a=n.all,o={},s="<([\\w]+)\\s+[^>]*?bx-tmpl=[\"']([^\"']+)[\"']\\s+[^>]*?bx-datakey=[\"']([^\"']+)[\"']\\s*[^>]*?>(@brix@)</\\1>",u=/\{\{#bx\-tmpl\-([^\}]*)?\}\}([\s\S]*?)\{\{\/bx\-tmpl\}\}/gi,l=/@TEMPLATE\|(.*?)\|TEMPLATE@/g;return e.augment(i,{_bx_praseTmpl:function(e,t){var n,i=this,s=!1;"string"==typeof e?"."===e.charAt(0)||"#"===e.charAt(0)||"body"===e?n=a(e):e=e.replace(l,function(e,t){return o[t]||r({url:t,dataType:"html",async:!1,success:function(e){o[t]=e}}),o[t]||""}):n=e,n&&("SCRIPT"==n.item(0)[0].nodeName.toUpperCase()?e=n.item(0).html():(a('script[type="text/tmpl"]').each(function(e){var n=e.html();n=i._bx_buildStoreTmpls(n),i._bx_buildSubTmpls(n,!1,t)}),s=!0)),s||(e=i._bx_buildStoreTmpls(e),i._bx_buildSubTmpls(e,!1,t),i.tmpl=e),i.inDom=s},_bx_buildStoreTmpls:function(e){var t=this;return e=e.replace(u,function(e,n,r){return t.storeTmpls[n]=r,""})},_bx_buildSubTmpls:function(e,t,n){var r=this;if(!t){for(t=s;n--;)t=t.replace("@brix@","(?:<\\1[^>]*>@brix@</\\1>|[\\s\\S])*?");t=t.replace("@brix@","(?:[\\s\\S]*?)")}for(var a,o=RegExp(t,"ig");null!==(a=o.exec(e));)r.subTmpls.push({name:a[2],datakey:a[3],tmpler:new i(a[4],!1)}),r._bx_buildSubTmpls(a[4],t)},addSubTmpl:function(e,t,n){var r=this;r.subTmpls=r.subTmpls||[],r.subTmpls.push({name:e,datakey:t,tmpler:new i(n,!1)})},getStoreTmpl:function(e){var t=this.storeTmpls;return t?t[e]||"":""},render:function(e){var n=this.tmpl;return"function"==typeof t?new t(n).render(e):t.render(n,e)}}),i},{requires:[Brix.templateEngine,"node","ajax","sizzle"]});