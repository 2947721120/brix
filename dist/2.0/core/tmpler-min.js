KISSY.add("brix/core/tmpler",function(e,n,t,r){function a(e,n){this.tmpls=[],e&&n!==!1?this._bx_praseTmpl(e,n):this.tmpl=e}var i=t.all,o={};return e.augment(a,{_bx_praseTmpl:function(e,n){var t,a=this,c=!1;if("string"==typeof e)if("."===e.charAt(0)||"#"===e.charAt(0)||"body"===e)t=i(e);else{var u=/@TEMPLATE\|(.*?)\|TEMPLATE@/g;u.test(e)&&(e=e.replace(u,function(e,n){return o[n]||r({url:n,dataType:"html",async:!1,success:function(e){o[n]=e}}),o[n]||""}))}else t=e;if(t&&("SCRIPT"==t.item(0)[0].nodeName.toUpperCase()?e=t.item(0).html():c=!0),!c){for(var l="<([\\w]+)\\s+[^>]*?bx-tmpl=[\"']([^\"']+)[\"']\\s+[^>]*?bx-datakey=[\"']([^\"']+)[\"']\\s*[^>]*?>(@brix@)</\\1>";n--;)l=l.replace("@brix@","(?:<\\1[^>]*>@brix@</\\1>|[\\s\\S])*?");l=l.replace("@brix@","(?:[\\s\\S]*?)"),a.reg=l,a.tmpl=e,a._bx_buildTmpls(a.tmpl)}a.inDom=c},_bx_buildTmpls:function(e){for(var n,t=this,r=RegExp(t.reg,"ig");null!==(n=r.exec(e));)t.tmpls.push({name:n[2],datakey:n[3],tmpler:new a(n[4],!1)}),t._bx_buildTmpls(n[4])},addTmpl:function(e,n,t){var r=this;r.tmpls.push({name:e,datakey:n,tmpler:new a(t,!1)})},getTmpl:function(){return this.tmpl},render:function(e){return"function"==typeof n?new n(this.getTmpl()).render(e):n.render(this.getTmpl(),e)}}),a},{requires:[Brix.templateEngine,"node","ajax","sizzle"]});