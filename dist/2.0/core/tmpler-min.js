KISSY.add("brix/core/tmpler",function(e,n,t,r){function a(e,n){e&&n!==!1?(this.subTmpls=[],this.storeTmpls={},this._bx_praseTmpl(e,n)):this.tmpl=e}var i=t.all,o={},u="<([\\w]+)\\s+[^>]*?bx-tmpl=[\"']([^\"']+)[\"']\\s+[^>]*?bx-datakey=[\"']([^\"']+)[\"']\\s*[^>]*?>(@brix@)</\\1>",c=/\{\{#bx\-tmpl\-(.*)\}\}([\s\S]*?)\{\{\/bx\-tmpl\}\}/gi,l=/@TEMPLATE\|(.*?)\|TEMPLATE@/g;return e.augment(a,{_bx_praseTmpl:function(n,t){var a,u=this,c=!1;"string"==typeof n?"."===n.charAt(0)||"#"===n.charAt(0)||"body"===n?a=i(n):n=n.replace(l,function(n,t){return e.log(t),o[t]||r({url:t,dataType:"html",async:!1,success:function(e){o[t]=e}}),o[t]||""}):a=n,a&&("SCRIPT"==a.item(0)[0].nodeName.toUpperCase()?n=a.item(0).html():(i('[type="text/tmpl"]').each(function(e){var n=e.html();n=u._bx_buildStoreTmpls(n),u._bx_buildSubTmpls(n,!1,t)}),c=!0)),c||(n=u._bx_buildStoreTmpls(n),u._bx_buildSubTmpls(n,!1,t),u.tmpl=n),u.inDom=c},_bx_buildStoreTmpls:function(e){var n=this;return e=e.replace(c,function(e,t,r){return n.storeTmpls[t]=r,""})},_bx_buildSubTmpls:function(e,n,t){var r=this,n=n;if(!n){for(n=u;t--;)n=n.replace("@brix@","(?:<\\1[^>]*>@brix@</\\1>|[\\s\\S])*?");n=n.replace("@brix@","(?:[\\s\\S]*?)")}for(var i,o=RegExp(n,"ig");null!==(i=o.exec(e));)r.subTmpls.push({name:i[2],datakey:i[3],tmpler:new a(i[4],!1)}),r._bx_buildSubTmpls(i[4],n)},addSubTmpl:function(e,n,t){var r=this;r.subTmpls=r.subTmpls||[],r.subTmpls.push({name:e,datakey:n,tmpler:new a(t,!1)})},getStoreTmpl:function(e){var n=this.storeTmpls;return n?n[e]||"":void 0},render:function(e){var t=this.tmpl;return"function"==typeof n?new n(t).render(e):n.render(t,e)}}),a},{requires:[Brix.templateEngine,"node","ajax","sizzle"]});