KISSY.add("brix/core/pagelet",function(e,t){function r(t){if(!t.attr("id")){for(var r;(r=e.guid("brix_brick_"))&&e.one("#"+r););t.attr("id",r)}return t.attr("id")}var n=t.extend({initializer:function(){var e=this;e.isReady=!1,e.readyList=[],e.bricks=[],e.isAddBehavior=!1,e.destroyed=!1},bindUI:function(){var e=this,t=e.get("callback");t&&"function"==typeof t&&e.ready(t),e.get("autoBehavior")&&e.addBehavior()},getBrick:function(t){var r=this,n=null;return e.each(r.bricks,function(e){return e.id===t?(n=e.brick,!1):void 0}),n},getBricks:function(t){var r=this,n=[];return e.each(r.bricks,function(e){e.name===t&&n.push(e.brick)}),n},destroyBrick:function(e){for(var t=this,r=0;t.bricks.length>r;r++){var n=t.bricks[r];if(e===n.id)return t._bx_destroyBrick(n),t.bricks.splice(r,1),!1}},_bx_destroyBrick:function(e){e.destroyed=!0,e.brick&&(e.brick.destroy&&e.brick.destroy(),e.brick=null)},addBehavior:function(){var e=this;if(e.get("rendered")&&!e.isAddBehavior){e.isAddBehavior=!0;var t=e.get("el"),r=t.all("[bx-name]");t.hasAttr("bx-name")&&(r=t.add(r)),e._bx_addBehavior(r,function(t){e.bricks=t},function(){e.on("beforeRefreshTmpl",function(t){"html"===t.renderType&&t.node.all("[bx-name]").each(function(t){e.destroyBrick(t.attr("id"))})}),e.on("afterRefreshTmpl",function(t){e._bx_addBehavior(t.node.all("[bx-name]"),function(t){t.length>0&&(e.bricks=e.bricks.concat(t))},function(){e._bx_fireReady()})}),e._bx_fireReady()})}},_bx_addBehavior:function(t,n,a){var i=this,o=i.get("config"),s=[];if(i.isReady=!1,t.each(function(t){if("true"!=t.attr("bx-behavior")){var n=r(t),a=t.attr("bx-name"),i=t.attr("bx-path"),c=Brix.returnJSON(t.attr("bx-config"));o&&o[n]&&e.mix(c,o[n]),t.attr("bx-behavior","true"),s.push({id:n,name:a,path:i,config:c})}}),s.length>0){var c=[];e.each(s,function(t){t.path||(t.path="brix/gallery/"+t.name+"/"),e.inArray(c,t.path)||t.config.autoBrick||c.push(t.path)}),i.fire("beforeAddBehavior",{useList:c}),n&&n(s),e.use(c.join(","),function(e){if(!i.destroyed){var t=arguments;e.each(s,function(r){if(!r.destroyed&&!r.config.autoBrick){var n=r.id,a=e.merge({container:"#"+n,el:"#"+n,pagelet:i},r.config),o=t[e.indexOf(r.path,c)+1],s=new o(a);r.brick=s}}),i.fire("afterAddBehavior",{useList:c,bricks:s}),c=null,t=null,a&&a()}})}else n&&n(s),a&&a()},ready:function(e){this.isReady?e.call(window,this):this.readyList.push(e)},_bx_fireReady:function(){var e=this;if(!e.isReady){e.isReady=!0;var t=e.readyList;if(e.readyList=[],t.length>0)for(var r,n=0;r=t[n++];)r.call(e);t=null}},destructor:function(){var t=this;if(e.each(t.bricks,function(e){t._bx_destroyBrick(e)}),t.bricks=null,t.get("rendered")){var r=t.get("destroyAction"),n=t.get("el");switch(r){case"remove":n.remove();break;case"empty":n.empty()}n=null}t.destroyed=!0}},{ATTRS:{autoBehavior:{value:!0},callback:{value:null},config:{value:{}}}},"Pagelet");return n},{requires:["./chunk"]});