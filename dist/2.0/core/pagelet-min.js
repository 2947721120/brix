KISSY.add("brix/core/pagelet",function(e,t){function r(t){if(!t.attr("id")){for(var r;(r=e.guid("brix_brick_"))&&e.one("#"+r););t.attr("id",r)}return t.attr("id")}var n=t.extend({initializer:function(){var e=this;e.isReady=!1,e.readyList=[],e.bricks=[],e.isAddBehavior=!1,e.destroyed=!1},bindUI:function(){var e=this,t=e.get("callback");t&&"function"==typeof t&&e.ready(t),e.get("autoBehavior")&&e.addBehavior()},getBrick:function(t){var r,n=this;return e.each(n.bricks,function(e){return e.id===t?(r=e.brick,!1):void 0}),r||null},destroyBrick:function(e){for(var t=this,r=0;t.bricks.length>r;r++){var n=t.bricks[r];if(e===n.id)return t._bx_destroyBrick(n),t.bricks.splice(r,1),!1}},_bx_destroyBrick:function(e){e.destroyed=!0,e.brick&&(e.brick.destroy&&e.brick.destroy(),e.brick=null)},addBehavior:function(){var e=this;if(e.get("rendered")&&!e.isAddBehavior){e.isAddBehavior=!0;var t=e.get("el"),r=t.all("[bx-name]");t.hasAttr("bx-name")&&(r=t.add(r)),e._bx_addBehavior(r,function(t){e.bricks=t},function(){e._bx_fireReady(),e.on("beforeRefreshTmpl",function(t){t.node.all("[bx-name]").each(function(t){e.destroyBrick(t.attr("id"))})}),e.on("afterRefreshTmpl",function(t){e._bx_addBehavior(t.node.all("[bx-name]"),function(t){t.length>0&&(e.bricks=e.bricks.concat(t))})})})}},_bx_addBehavior:function(t,n,a){var i=this,o=i.get("config"),c=[];if(t.each(function(t){var n=r(t),a=t.attr("bx-name"),i=t.attr("bx-path"),l=t.attr("bx-config");l=l?Function("return "+l)():{},o&&o[n]&&e.mix(l,o[n]),c.push({id:n,name:a,path:i,config:l})}),c.length>0){var l=[];e.each(c,function(t){t.path||(t.path="brix/gallery/"+t.name+"/"),e.inArray(l,t.path)||l.push(t.path)}),i.fire("beforeAddBehavior",{useList:l}),n&&n(c),e.use(l.join(","),function(e){if(!i.destroyed){var t=arguments;e.each(c,function(r){if(!r.destroyed){var n=r.id,a=e.merge({container:"#"+n,el:"#"+n,pagelet:i},r.config),o=t[e.indexOf(r.path,l)+1],c=new o(a);r.brick=c}}),t=null,a&&a()}})}else n&&n(c),a&&a()},ready:function(e){this.isReady?e.call(window,this):this.readyList.push(e)},_bx_fireReady:function(){var e=this;if(!e.isReady&&(e.isReady=!0,e.readyList)){for(var t,r=0;t=e.readyList[r++];)t.call(e);e.readyList=null}},destructor:function(){var t=this;if(e.each(t.bricks,function(e){t._bx_destroyBrick(e)}),t.bricks=null,t.get("rendered")){var r=t.get("destroyAction"),n=t.get("el");switch(r){case"remove":n.remove();break;case"empty":n.empty()}n=null}t.destroyed=!0}},{ATTRS:{autoBehavior:{value:!0},callback:{value:null},config:{value:{}}}},"Pagelet");return n},{requires:["./chunk"]});