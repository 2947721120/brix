/*! Brix - v2.0
* https://github.com/etaoux/brix
* Copyright (c) 2013 etaoux; Licensed MIT */ 
(function(e,t){function r(e){return e?Function("return "+e)():{}}function n(){var t,n,a=/^(.*)(brix)(?:-min)?\.js[^\/]*/i,i=/(brix)(?:-min)?\.js/i,l=s.document.getElementsByTagName("script"),c=l[l.length-1],u=c.src,d=r(c.getAttribute("bx-config"));o&&-1!==(o.search||"").indexOf("bx-debug")&&(d.debug=!0),t=d.comboPrefix=d.comboPrefix||"??",n=d.comboSep=d.comboSep||",";var b,p,v=u.indexOf(t);return-1==v?p=u.replace(a,"$1"):(p=u.substring(0,v),"/"!=p.charAt(p.length-1)&&(p+="/"),b=u.substring(v+t.length).split(n),e.each(b,function(e){return e.match(i)?(p+=e.replace(a,"$1"),!1):void 0})),p=""+f.resolve(p),p=p.substring(0,p.lastIndexOf("brix")),e.mix({autoConfig:!0,base:p},d)}var a=!1,i=[],s=e.Env.host,o=s.location,l="",c="20121226",u="2.0",d=!1;t=s[t]=s[t]||{};var f=new e.Uri(o.href),b=n();return e.mix(t,{config:function(r){d||(d=!0,r=e.merge({componentsPath:"./",importsPath:"./",templateEngine:"brix/gallery/mu/",debug:""===l?!1:!0,combine:!1,tag:"@TAG@"==c?"":c,fixed:"@VERSION@"==u?"src/":u+"/",gallery:{}},b,r),t.basePath=r.base,t.fixed=r.fixed,t.templateEngine=r.templateEngine,e.config({packages:[{name:"brix",base:r.base,combine:r.combine,debug:r.debug,tag:r.tag,charset:"utf-8"},{name:"components",base:r.componentsPath,combine:r.combine,debug:r.debug,tag:r.componentsTag||r.tag,charset:"utf-8"},{name:"imports",base:r.importsPath,combine:r.combine,debug:r.debug,tag:r.importsTag||r.tag,charset:"utf-8"}]}),e.config({map:[[/(.+brix\/)(gallery\/)(.+?)(\/.+?(?:-min)?\.(?:js|css))(\?[^?]+)?$/,function(e,t,n,a,i,s){var o=t+r.fixed+n+a;return r.gallery[a]&&(o+="/"+r.gallery[a]),o+=i+(s?s:"")}],[/(.+brix\/)(core.+?)((?:-min)?\.js)(\?[^?]+)?$/,function(e,t,n,a,i){var s=t+r.fixed;return s+=n+a+(i?i:"")}]]}))},ready:function(e){a?e.call(t):i.push(e)},_bx_fireReady:function(){if(!a&&(a=!0,i)){for(var e,r=0;e=i[r++];)e.call(t);i=null}},returnJSON:function(e){return r(e)},absoluteFilePath:function(t,r){return""+new e.Uri(t.getFullPath()).resolve(r)}}),b.autoConfig&&(t.config({}),b.autoPagelet)?(e.later(function(){e.use("brix/core/pagelet",function(e,r){e.ready(function(){t.pagelet=new r({tmpl:"body"}),t._bx_fireReady()})})},1),void 0):(e.ready(function(){t._bx_fireReady()}),void 0)})(KISSY,"Brix"),KISSY.add("brix/core/tmpler",function(e,t,r,n){function a(e,t){e&&t!==!1?(this.subTmpls=[],this.storeTmpls={},this._bx_praseTmpl(e,t)):this.tmpl=e}var i=r.all,s={},o="<([\\w]+)\\s+[^>]*?bx-tmpl=[\"']([^\"']+)[\"']\\s+[^>]*?bx-datakey=[\"']([^\"']+)[\"']\\s*[^>]*?>(@brix@)</\\1>",l=/\{\{#bx\-tmpl\-(.*)\}\}([\s\S]*?)\{\{\/bx\-tmpl\}\}/gi,c=/@TEMPLATE\|(.*?)\|TEMPLATE@/g;return e.augment(a,{_bx_praseTmpl:function(e,t){var r,a=this,o=!1;"string"==typeof e?"."===e.charAt(0)||"#"===e.charAt(0)||"body"===e?r=i(e):e=e.replace(c,function(e,t){return s[t]||n({url:t,dataType:"html",async:!1,success:function(e){s[t]=e}}),s[t]||""}):r=e,r&&("SCRIPT"==r.item(0)[0].nodeName.toUpperCase()?e=r.item(0).html():(i('[type="text/tmpl"]').each(function(e){var r=e.html();r=a._bx_buildStoreTmpls(r),a._bx_buildSubTmpls(r,!1,t)}),o=!0)),o||(e=a._bx_buildStoreTmpls(e),a._bx_buildSubTmpls(e,!1,t),a.tmpl=e),a.inDom=o},_bx_buildStoreTmpls:function(e){var t=this;return e=e.replace(l,function(e,r,n){return t.storeTmpls[r]=n,""})},_bx_buildSubTmpls:function(e,t,r){var n=this;if(t=t,!t){for(t=o;r--;)t=t.replace("@brix@","(?:<\\1[^>]*>@brix@</\\1>|[\\s\\S])*?");t=t.replace("@brix@","(?:[\\s\\S]*?)")}for(var i,s=RegExp(t,"ig");null!==(i=s.exec(e));)n.subTmpls.push({name:i[2],datakey:i[3],tmpler:new a(i[4],!1)}),n._bx_buildSubTmpls(i[4],t)},addSubTmpl:function(e,t,r){var n=this;n.subTmpls=n.subTmpls||[],n.subTmpls.push({name:e,datakey:t,tmpler:new a(r,!1)})},getStoreTmpl:function(e){var t=this.storeTmpls;return t?t[e]||"":void 0},render:function(e){var r=this.tmpl;return"function"==typeof t?new t(r).render(e):t.render(r,e)}}),a},{requires:[Brix.templateEngine,"node","ajax","sizzle"]}),KISSY.add("brix/core/dataset",function(e,t){function r(){r.superclass.constructor.apply(this,arguments)}return r.ATTRS={data:{}},e.extend(r,t,{setRenderer:function(e,t,r){var n,a,i=this,s=i.get("data");if(r=r?r+"_":"",e){var o=function(n,a){var i=r+n+"_"+a,o=e[n][a];s[i]=function(){return o.call(this,t,n)}};for(n in e)for(a in e[n])o(n,a)}}}),r},{requires:["base"]}),KISSY.add("brix/core/chunk",function(e,t,r,n,a,i){function s(e,t){for(var r=0;e.length>r;r++)for(var n=0;t.length>n;n++)if(e[r]==t[n])return!0;return!1}var o=t.all,l=e.noop,c=n.extend({constructor:function c(){var e=this;c.superclass.constructor.apply(e,arguments);var t=e.get("tmpler");(e.get("autoRender")||!t||t.inDom)&&e.render()},bindInternal:l,syncInternal:l,initializer:function(){var e=this,t=e.get("tmpl");if(t){e._bx_buildTmpler(t,e.get("level"));var r=e.get("tmpler");r&&(e._bx_buildDataset(e.get("data")),r.inDom&&e.set("el",t))}},_bx_buildTmpler:function(e,t){var r=this;if(!r.get("isBuidTmpler")){r.set("isBuidTmpler",!0);var n=new i(e,t);r.set("tmpler",n)}},_bx_buildDataset:function(t){var r=this;if(!r.get("isBuidDataset")){r.set("isBuidDataset",!0),t=e.clone(t||{});var n=new a({data:t}),i=r.get("renderer");i&&n.setRenderer(i,r),r.set("dataset",n),n.on("*Change",function(t){var a=!1,i=e.map(t.subAttrName,function(e){return/^data\./g.test(e)?(a=!0,e.replace(/^data\./,"")):"zuomo.xb@taobao.com"});a&&r._bx_renderTmpl(i,n.get("data"))})}},destructor:function(){var e=this,t=e.get("tmpler"),r=e.get("dataset");t&&e.set("tmpler",null),r&&(e.set("dataset",null),r.detach()),e.detach()},bindUI:l,syncUI:l,addSubTmpl:function(e,t,r){var n=this;if(n._bx_buildTmpler("",!1),n._bx_buildDataset(),e){var a=n.get("tmpler");a.addSubTmpl(e,t,r)}},getStoreTmpl:function(e){var t=this,r=t.get("tmpler");return r?r.getStoreTmpl(e):""},setChunkData:function(t,r,n){var a=this,i=a.get("dataset");if(i){if(e.isObject(t)){t=e.clone(t);var s={};for(var o in t)s["data."+o]=t[o];t=s,n=r}else t="data."+t,r=e.clone(r);var l="html";n&&n.renderType&&(l=n.renderType,delete n.renderType),a.set("renderType",l),i.set.apply(i,arguments)}},render:function(){var e=this;if(!e.get("rendered")){e.fire("beforeRenderUI");var t=e.get("dataset");t&&e._bx_render(t.get("data")),e.fire("afterRenderUI"),e.setInternal("rendered",!0),e.fire("beforeBindUI"),c.superclass.bindInternal.call(e),e.callMethodByHierarchy("bindUI","__bindUI"),e.callMethodByHierarchy("initialize","constructor"),e.fire("afterBindUI"),e.fire("beforeSyncUI"),c.superclass.syncInternal.call(e),e.callMethodByHierarchy("syncUI","__syncUI"),e.fire("afterSyncUI")}return e},_bx_render:function(n){var a=this,i=a.get("tmpler");if(i&&!i.inDom){var s,l=a.get("container"),c=a.get("el"),u=e.trim(i.render(n));if(c&&0!==c.length)if(8>=r.ie){for(s=new t("<div />"),l.append(s),s.html(u);s[0].childNodes.length>0;)l[0].appendChild(s[0].childNodes[0]);s.remove(),s=null}else l.append(u);else{var d="brix_"+e.guid();if(8>=r.ie){s=new t("<div />"),l.append(s),s.html(u);var f=s[0].childNodes;if(f.length>1)s.attr("id",d);else{for(d=f[0].id||d,f[0].id=d;f.length>0;)l[0].appendChild(f[0]);s.remove(),s=null}}else s=new t(u),s.length>1?s=o('<div id="'+d+'"></div>').append(s):(d=s.attr("id")||d,s.attr("id",d)),l.append(s);a.set("el","#"+d)}}},_bx_renderTmpl:function(t,r){var n=this,a=n.get("tmpler");if(a&&n.get("rendered")){var i=n.get("el"),o=a.subTmpls;e.each(o,function(a){var o=e.map(a.datakey.split(","),function(t){return e.trim(t)});if(s(o,t)){var l=i.all("[bx-tmpl="+a.name+"]");i.attr("bx-tmpl")==a.name&&(l=i.add(l)),l.each(function(t){if(t.attr("bx-datakey")==a.datakey){var i={};e.each(o,function(e){for(var t=r,n=e.split("."),a=n.length,s=0;s!==a;)t=t[n[s]],s++;i[n[a-1]]=t,t=null}),e.each(r,function(t,r){e.isFunction(t)&&(i[r]=t)});var s=n.get("renderType")||"html";n.fire("beforeRefreshTmpl",{node:t,renderType:s}),t[s](e.trim(a.tmpler.render(i))),n.fire("afterRefreshTmpl",{node:t}),i=null}}),l=null}})}}},{ATTRS:{el:{getter:function(t){return e.isString(t)&&(t=o(t)),t}},destroyAction:{value:"remove"},container:{value:"body",getter:function(t){return e.isString(t)&&(t=o(t)),t}},tmpl:{value:!1},tmpler:{value:!1},rendered:{value:!1},autoRender:{value:!0},data:{value:!1},dataset:{value:!1},renderer:{value:!1},level:{value:3}}});return c},{requires:["node","ua","rich-base","./dataset","./tmpler"]}),KISSY.add("brix/core/brick",function(e,t,r){var n=t.extend({initializer:function(){for(var e=this,t=e.constructor;t;){var r=t.RENDERERS;r&&(e.addSubTmpl(),e.get("dataset").setRenderer(r,e)),t=t.superclass&&t.superclass.constructor}e.pagelet=e.get("pagelet")},bindUI:function(){var e=this;e._bx_bindEvent()},_bx_detachEvent:function(){for(var e=this,t=e.constructor;t;){var r=t.EVENTS;r&&e._bx_removeEvents(r);var n=t.DOCEVENTS;n&&e._bx_removeEvents(n,document),t=t.superclass&&t.superclass.constructor}var a=e.get("events");a&&this._bx_removeEvents(a)},_bx_bindEvent:function(){for(var e=this,t=e.constructor;t;){var r=t.EVENTS;r&&this._bx_addEvents(r);var n=t.DOCEVENTS;n&&this._bx_addEvents(n,document),t=t.superclass&&t.superclass.constructor}var a=e.get("events");a&&this._bx_addEvents(a)},_bx_removeEvents:function(e,t){t=t||this.get("el");for(var n in e){var a=e[n];for(var i in a){var s=a[i];""===n?r.detach(t,i,s,this):r.undelegate(t,i,n,s,this)}}},_bx_addEvents:function(e,t){t=t||this.get("el");for(var n in e){var a=e[n];for(var i in a){var s=a[i];""===n?r.on(t,i,s,this):r.delegate(t,i,n,s,this)}}},destructor:function(){var e=this;if(e.get("rendered")){e._bx_detachEvent();var t=e.get("destroyAction"),r=e.get("el");switch(t){case"remove":r.remove();break;case"empty":r.empty()}}e.get("pagelet")&&(delete e.pagelet,e.set("pagelet",null))}},{ATTRS:{pagelet:{value:null}}},"Brick");return n},{requires:["./chunk","event"]}),KISSY.add("brix/core/pagelet",function(e,t){function r(t){if(!t.attr("id")){for(var r;(r=e.guid("brix_brick_"))&&e.one("#"+r););t.attr("id",r)}return t.attr("id")}var n=t.extend({initializer:function(){var e=this;e.isReady=!1,e.readyList=[],e.bricks=[],e.isAddBehavior=!1,e.destroyed=!1},bindUI:function(){var e=this,t=e.get("callback");t&&"function"==typeof t&&e.ready(t),e.get("autoBehavior")&&e.addBehavior()},getBrick:function(t){var r=this,n=null;return e.each(r.bricks,function(e){return e.id===t?(n=e.brick,!1):void 0}),n},getBricks:function(t){var r=this,n=[];return e.each(r.bricks,function(e){e.name===t&&n.push(e.brick)}),n},destroyBrick:function(e){for(var t=this,r=0;t.bricks.length>r;r++){var n=t.bricks[r];if(e===n.id)return t._bx_destroyBrick(n),t.bricks.splice(r,1),!1}},_bx_destroyBrick:function(e){e.destroyed=!0,e.brick&&(e.brick.destroy&&e.brick.destroy(),e.brick=null)},addBehavior:function(){var e=this;if(e.get("rendered")&&!e.isAddBehavior){e.isAddBehavior=!0;var t=e.get("el"),r=t.all("[bx-name]");t.hasAttr("bx-name")&&(r=t.add(r)),e._bx_addBehavior(r,function(t){e.bricks=t},function(){e.on("beforeRefreshTmpl",function(t){"html"===t.renderType&&t.node.all("[bx-name]").each(function(t){e.destroyBrick(t.attr("id"))})}),e.on("afterRefreshTmpl",function(t){e._bx_addBehavior(t.node.all("[bx-name]"),function(t){t.length>0&&(e.bricks=e.bricks.concat(t))},function(){e._bx_fireReady()})}),e._bx_fireReady()})}},_bx_addBehavior:function(t,n,a){var i=this,s=i.get("config"),o=[];if(i.isReady=!1,t.each(function(t){if("true"!=t.attr("bx-behavior")){var n=r(t),a=t.attr("bx-name"),i=t.attr("bx-path"),l=Brix.returnJSON(t.attr("bx-config"));s&&s[n]&&e.mix(l,s[n]),t.attr("bx-behavior","true"),o.push({id:n,name:a,path:i,config:l})}}),o.length>0){var l=[];e.each(o,function(t){t.path||(t.path="brix/gallery/"+t.name+"/"),e.inArray(l,t.path)||t.config.autoBrick||l.push(t.path)}),i.fire("beforeAddBehavior",{useList:l}),n&&n(o),e.use(l.join(","),function(e){if(!i.destroyed){var t=arguments;e.each(o,function(r){if(!r.destroyed&&!r.config.autoBrick){var n=r.id,a=e.merge({container:"#"+n,el:"#"+n,pagelet:i},r.config),s=t[e.indexOf(r.path,l)+1],o=new s(a);r.brick=o}}),i.fire("afterAddBehavior",{useList:l,bricks:o}),l=null,t=null,a&&a()}})}else n&&n(o),a&&a()},ready:function(e){this.isReady?e.call(window,this):this.readyList.push(e)},_bx_fireReady:function(){var e=this;if(!e.isReady){e.isReady=!0;var t=e.readyList;if(e.readyList=[],t.length>0)for(var r,n=0;r=t[n++];)r.call(e);t=null}},destructor:function(){var t=this;if(e.each(t.bricks,function(e){t._bx_destroyBrick(e)}),t.bricks=null,t.get("rendered")){var r=t.get("destroyAction"),n=t.get("el");switch(r){case"remove":n.remove();break;case"empty":n.empty()}n=null}t.destroyed=!0}},{ATTRS:{autoBehavior:{value:!0},callback:{value:null},config:{value:{}}}},"Pagelet");return n},{requires:["./chunk"]}),KISSY.add("brix/core/demolet",function(e,t,r,n){function a(e){return o[e]?!1:(o[e]=!0,r({url:e,dataType:"text",async:!1,complete:function(e,t){"success"==t&&s("<style>"+e+"</style>").appendTo("head")}}),void 0)}function i(t,n,a){a=a||"@",n=n||{};var i=RegExp("\\{\\{"+a+"(.+)?\\}\\}","ig");return t=t.replace(i,function(t,a){e.log(a);var i="",s=a.replace(/\//gi,"_").replace(/\./gi,"_");return n[s]=n[s]||{},r({url:a+"template.html",dataType:"html",async:!1,success:function(e){i="{{#"+s+"}}"+e+"{{/"+s+"}}"}}),r({url:a+"data.json",async:!1,dataType:"json",success:function(e){for(var t in e)n[s][t]=e[t]}}),i}),{tmpl:t,data:n}}var s=n.all,o={},l=t.extend({initializer:function(){var t=this;t.on("beforeAddBehavior",function(r){e.each(t.get("projectCSS"),function(e){a(e)});var n=r.useList;e.each(n,function(t){if(e.startsWith(t,"brix/"))e.use(t+"index.css");else{var r=3;e.startsWith(t,"imports/")&&(r=5);var n=t.split("/");n.length>r&&(n.splice(n.length-2),a(n.join("/")+"/index.css")),a(t.substring(0,t.lastIndexOf("/"))+"/index.css")}})})}},{ATTRS:{projectCSS:{value:[],setter:function(t){return e.isArray(t)?t:[t]}},s:{value:"@"},tmpl:{setter:function(e){var t=this,r=t.get("data")||{},n=i(e,r,t.get("s"));return t.set("data",n.data),n.tmpl}}}},"Demolet");return l},{requires:["./pagelet","ajax","node"]});