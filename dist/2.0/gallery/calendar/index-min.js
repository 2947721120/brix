KISSY.add("brix/gallery/calendar/index",function(e,t,n,i,r){function a(){a.superclass.constructor.apply(this,arguments);var t=this,n=t.get("popup"),i=e.one(t.get("trigger"));if(n&&i){var r=t.get("triggerType");e.each(r,function(e){i.on(e,t.toggle,t)})}}return a.Date=r,a.ATTRS={date:{value:new Date},selected:{value:null},startDay:{value:0},pages:{value:1},closable:{value:!1},rangeSelect:{value:!1},minDate:{value:!1},maxDate:{value:!1},multiSelect:{value:!1},multi:{value:null,setter:function(e){for(var t=0;e.length>t;t++)e[t]instanceof Date&&(e[t]=r.format(e[t],"isoDate"));return e}},navigator:{value:!0},popup:{value:!0},showTime:{value:!1},trigger:{value:!1},triggerType:{value:["click"]},disabled:{value:!1},range:{value:!1},rangeLinkage:{value:!0},align:{value:{node:!1,points:["bl","tl"],offset:[0,0]}},notLimited:{value:!1},tmpl:{getter:function(e){if(!e){var t=this;e='<div class="calendar-pages"></div><div bx-tmpl="calendar" bx-datakey="notLimited,multiSelect,showTime,op_html" class="calendar-operator">{{{op_html}}}</div>',t.get("el")||(e='<div class="calendar">'+e+"</div>")}return e}},autoRender:{value:!1}},a.FIRES={select:"select",monthChange:"monthChange",timeSelect:"timeSelect",rangeSelect:"rangeSelect",multiSelect:"multiSelect",show:"show",hide:"hide"},a.RENDERERS={op:{html:function(e){var t=e,n=t.get("notLimited"),i=t.get("showTime"),r=t.get("multiSelect"),a="";return(i||r)&&(a+='<a class="btn btn-size25 btn-calendar-confirm">\u786e\u5b9a</a>'),n&&(a+='<a class="btn btn-size25 btn-calendar-notlimited">\u4e0d\u9650</a>'),a}}},a.DOCEVENTS={"":{click:function(t){var n=this,i=n.get("el"),r=e.one(t.target),a=e.one(n.get("trigger"));i.equals(r)||i.contains(r)||!a||a.contains(r)||r[0]==a[0]||n.hide()}}},a.EVENTS={".btn-calendar-confirm":{click:function(){var t=this,n=t.get("selected"),i=t.get("showTime"),o=t.get("multiSelect");if(o){var s=e.clone(t.get("multi"));s.sort(function(e,t){return e>t?1:-1});for(var l=0;s.length>l;l++)s[l]=r.parse(s[l]);e.log(s),t.fire(a.FIRES.multiSelect,{multi:s})}else if(i){var c=new Date;n&&(c=n);var u=t.pageBricks[0].timeBrick.get("time");c.setHours(u.getHours()),c.setMinutes(u.getMinutes()),c.setSeconds(u.getSeconds()),e.log(c),t.fire(a.FIRES.timeSelect,{date:c})}t.hide()}},".btn-calendar-notlimited":{click:function(){var e=this,t=e.get("notLimited");t&&(e.fire(a.FIRES.select,{date:null}),e.hide())}}},a.METHODS={show:function(){var t=this;if(t.get("rendered")||t.render(),t.overlay){var n=e.clone(t.get("align"));n.node||(n.node=t.get("trigger")),t.overlay.set("align",n),t.overlay.show(),t.fire(a.FIRES.show)}},hide:function(){var e=this;e.overlay&&(e.overlay.hide(),e.fire(a.FIRES.hide))},toggle:function(e){var t=this;e&&e.preventDefault();var t=this;t.overlay?"hidden"==t.overlay.get("el").css("visibility")?t.show():t.hide():t.show()}},e.extend(a,t,{initialize:function(){var t=this,r=t.get("popup"),o=t.get("closable"),s=t.get("pages"),l=t.get("rangeLinkage"),c=t.get("el"),u=t.get("date"),d=u.getMonth(),f=u.getFullYear(),p=t.get("trigger");if(r){var h=e.clone(t.get("align"));h.node||(h.node=p),t.overlay=new n({srcNode:t.get("el"),align:h}),t.overlay.render()}else c.css({position:"static",visibility:"visible"});var g=c.one(".calendar-pages");t.pageBricks=[],c.addClass(".calendar-"+s);for(var v,m,b=0;s>b;b++)l?(v=0==b,m=b==s-1):(v=!0,m=!0),function(e){var n=new i({index:e,prev:v,next:m,year:f,month:d,father:t,destroyAction:t.get("destroyAction"),container:g});t.pageBricks.push(n),n.on("itemClick",function(e){var n=t.get("rangeSelect");n?t._handleRange(e.date):e.date&&(t.set("selected",e.date),t.fire(a.FIRES.select,{date:e.date}),r&&o&&!t.get("showTime")&&t.hide())}),n.on("itemMouseDown",function(e){var n=t.get("multiSelect");n&&t._handleMultiSelectStart(e.date)}),n.on("itemMouseUp",function(e){var n=t.get("multiSelect");n&&t._handleMultiSelectEnd(e.date)}),n.on("monthChange",function(e){t._bindDateValueChange(e.date,e.index)})}(b),11==d?(f++,d=0):d++;t._bindDataChange("range"),t._bindDataChange("multi"),t._bindDataChange("disabled"),t._bindDataChange("minDate"),t._bindDataChange("maxDate"),t._bindDataChange("selected"),t._bindDataChange("startDay"),t.on("afterDateChange",function(){t._bindDateValueChange(t.get("date"))})},destructor:function(){var t=this;if(trigger=e.one(t.get("trigger")),t.get("popup")&&trigger){var n=t.get("triggerType");e.each(n,function(e){trigger.detach(e,t.toggle,t)})}t.pageBricks&&(e.each(t.pageBricks,function(e){e.destroy()}),t.pageBricks=null),t.overlay&&t.overlay.destroy()},_bindDataChange:function(e,t){var n=this,t=e.replace(/\b(\w)|\s(\w)/g,function(e){return e.toUpperCase()});n.on("after"+t+"Change",function(){for(var t=n.get(e),i=0;n.pageBricks.length>i;i++)n.pageBricks[i].setChunkData(e,t)})},_bindDateValueChange:function(e,t){t=t||0;var n=this,i=n.get("rangeLinkage"),r=e.getFullYear(),o=e.getMonth();if(i){for(var s=0;n.pageBricks.length>s;s++){var l=o-t+s,c=r;0>l?(c--,l+=12):l>11&&(c++,l-=12),n.pageBricks[s].set("year",c),n.pageBricks[s].set("month",l)}var u=r,d=o-t;0>d&&(u--,d+=12),n.fire(a.FIRES.monthChange,{date:new Date(u,d,1)})}else n.pageBricks[t].set("year",r),n.pageBricks[t].set("month",o),n.fire(a.FIRES.monthChange,{date:new Date(r,o,1)})},_handleRange:function(t){var n,i=this,r=e.clone(i.get("range"))||{};if(!r.start&&!r.end||r.start&&r.end)r.start=t,r.end=null,i.set("range",r);else{r.end=t,r.start.getTime()>r.end.getTime()&&(n=r.start,r.start=r.end,r.end=n),i.set("range",r),i.fire(a.FIRES.rangeSelect,r);var o=i.get("popup"),s=i.get("closable");o&&s&&i.hide()}},_handleMultiSelectStart:function(e){this.multiStartDate=e},_handleMultiSelectEnd:function(t){if(this.multiStartDate){var n,i=this,a=e.clone(i.get("multi"))||[],o=i.multiStartDate,s=(i.get("minDate"),i.get("maxDate"),i.get("disabled"));for(o>t?(n=o,o=t):n=t;n>=o;)if(!r.isDisabled(s,o)){var l=r.format(o,"isoDate");e.inArray(l,a)?a.splice(e.indexOf(l,a),1):a.push(l),o.setDate(o.getDate()+1)}delete i.multiStartDate,i.set("multi",a)}}}),e.augment(a,a.METHODS),a},{requires:["brix/core/brick","overlay","./page","./date"]});