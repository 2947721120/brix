KISSY.add("brix/gallery/timer/index",function(a,b,c){function d(){d.superclass.constructor.apply(this,arguments)}return d.ATTRS={mode:{value:"down"},updateTime:{value:1e4},units:{value:"s"},isServer:{value:!1},ajusted:{value:!1},ajustInterval:{value:5e3},interval:{value:100},data:{valueFn:function(){return this._getUnitsData(0)}}},d.FIRES={notify:"notify"},d.getServerTime=function(b,d){if(d){var e=window.location.protocol+"//"+window.location.host+"?t="+ +(new Date);c({type:"head",url:e,success:function(a,c,d){var e=(new Date(d.getResponseHeader("Date"))).getTime();b(e)}})}else b(a.now())},a.extend(d,b,{initialize:function(){var a=this;d.getServerTime(function(b){a._start(b)},a.get("isServer"))},_start:function(b){var c=this,d=c.get("mode"),e=c.get("interval"),f=c.get("ajustInterval"),g=c.get("updateTime"),h;switch(d){case"up":h=b-g;break;case"down":h=g}c._currentTime=h,c._startCurrentTime=h,c._startBaseTime=b,c._diffTime=0,c._timerHandler=a.later(c._timerInterval,e,!1,c,[e,d]),c.get("ajusted")&&(c._ajustHandler=a.later(c._ajustInterval,f,!1,c,[f,d]))},_ajustInterval:function(b,c){var e=this;d.getServerTime(function(d){e._diffTime=d-e._startBaseTime;switch(c){case"up":e._diffTime-=e._currentTime-e._startCurrentTime;break;case"down":e._diffTime-=e._startCurrentTime-e._currentTime}if(e._diffTime>500){switch(c){case"up":e._currentTime+=e._diffTime;break;case"down":e._currentTime-=e._diffTime,e._currentTime<=0&&(e._currentTime=interval)}e._diffTime=0}e._ajustHandler=a.later(e._ajustInterval,b,!1,e,[b,c])},e.get("isServer"))},_timerInterval:function(b,c){var e=this,f=e._currentTime;switch(c){case"up":f+=b;break;case"down":f-=b}e._currentTime=f;var g=e._getUnitsData(f);a.each(g,function(a,b){e.setChunkData(b,a)});if(f<=0){e._ajustHandler&&e._ajustHandler.cancel(),e.fire(d.FIRES.notify);return}e._timerHandler=a.later(e._timerInterval,b,!1,e,[b,c])},_getUnitsData:function(b){var c=this,d={};switch(c.get("units")){case"y":d={y:Math.floor(b/31536e6),M:Math.floor(b/2592e6)%12,d:Math.floor(b/864e5)%30,h:Math.floor(b/36e5)%24,m:Math.floor(b/6e4)%60,s:Math.floor(b/1e3)%60,hs:Math.floor(b/100)%10};break;case"M":d={M:Math.floor(b/2592e6),d:Math.floor(b/864e5)%30,h:Math.floor(b/36e5)%24,m:Math.floor(b/6e4)%60,s:Math.floor(b/1e3)%60,hs:Math.floor(b/100)%10};break;case"d":d={d:Math.floor(b/864e5),h:Math.floor(b/36e5)%24,m:Math.floor(b/6e4)%60,s:Math.floor(b/1e3)%60,hs:Math.floor(b/100)%10};break;case"h":d={h:Math.floor(b/36e5),m:Math.floor(b/6e4)%60,s:Math.floor(b/1e3)%60,hs:Math.floor(b/100)%10};break;case"m":var d={m:Math.floor(b/6e4),s:Math.floor(b/1e3)%60,hs:Math.floor(b/100)%10};break;case"s":d={s:Math.floor(b/1e3),hs:Math.floor(b/100)%10};break;case"hs":d={hs:Math.floor(b/100)}}return a.each(d,function(b,c){a.inArray(c,["h","m","s"])&&b<10&&(d[c]=("0"+b).toString()),d[c]=d[c].toString()}),c.get("interval")>=1e3&&delete d.hs,d},destructor:function(){this._ajustHandler&&(this._ajustHandler.cancel(),this._ajustHandler=null),this._timerHandler&&(this._timerHandler.cancel(),this._timerHandler=null)}}),d},{requires:["brix/core/brick","ajax"]});