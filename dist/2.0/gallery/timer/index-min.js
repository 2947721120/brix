KISSY.add("brix/gallery/timer/index",function(e,t,i){function a(){a.superclass.constructor.apply(this,arguments)}return a.ATTRS={mode:{value:"down"},updateTime:{value:1e4},units:{value:"s"},isServer:{value:!1},ajusted:{value:!1},ajustInterval:{value:5e3},interval:{value:100},data:{valueFn:function(){return this._getUnitsData(0)}}},a.FIRES={notify:"notify"},a.getServerTime=function(t,a){if(a){var n=window.location.protocol+"//"+window.location.host+"?t="+ +new Date;i({type:"head",url:n,success:function(e,i,a){var n=new Date(a.getResponseHeader("Date")).getTime();t(n)}})}else t(e.now())},e.extend(a,t,{initialize:function(){var e=this;a.getServerTime(function(t){e._start(t)},e.get("isServer"))},_start:function(t){var i,a=this,n=a.get("mode"),r=a.get("interval"),s=a.get("ajustInterval"),o=a.get("updateTime");switch(n){case"up":i=t-o;break;case"down":i=o}a._currentTime=i,a._startCurrentTime=i,a._startBaseTime=t,a._diffTime=0,a._timerHandler=e.later(a._timerInterval,r,!1,a,[r,n]),a.get("ajusted")&&(a._ajustHandler=e.later(a._ajustInterval,s,!1,a,[s,n]))},_ajustInterval:function(t,i){var n=this;a.getServerTime(function(a){switch(n._diffTime=a-n._startBaseTime,i){case"up":n._diffTime-=n._currentTime-n._startCurrentTime;break;case"down":n._diffTime-=n._startCurrentTime-n._currentTime}if(n._diffTime>500){switch(i){case"up":n._currentTime+=n._diffTime;break;case"down":n._currentTime-=n._diffTime,0>=n._currentTime&&(n._currentTime=0)}n._diffTime=0}n._ajustHandler=e.later(n._ajustInterval,t,!1,n,[t,i])},n.get("isServer"))},_timerInterval:function(t,i){var n=this,r=n._currentTime;switch(i){case"up":r+=t;break;case"down":r-=t}n._currentTime=r;var s=n._getUnitsData(r);return e.each(s,function(e,t){n.setChunkData(t,e)}),0>=r?(n._ajustHandler&&n._ajustHandler.cancel(),n.fire(a.FIRES.notify),void 0):(n._timerHandler=e.later(n._timerInterval,t,!1,n,[t,i]),void 0)},_getUnitsData:function(t){var i=this,a={};switch(i.get("units")){case"y":a={y:Math.floor(t/31536e6),M:Math.floor(t/2592e6)%12,d:Math.floor(t/864e5)%30,h:Math.floor(t/36e5)%24,m:Math.floor(t/6e4)%60,s:Math.floor(t/1e3)%60,hs:Math.floor(t/100)%10};break;case"M":a={M:Math.floor(t/2592e6),d:Math.floor(t/864e5)%30,h:Math.floor(t/36e5)%24,m:Math.floor(t/6e4)%60,s:Math.floor(t/1e3)%60,hs:Math.floor(t/100)%10};break;case"d":a={d:Math.floor(t/864e5),h:Math.floor(t/36e5)%24,m:Math.floor(t/6e4)%60,s:Math.floor(t/1e3)%60,hs:Math.floor(t/100)%10};break;case"h":a={h:Math.floor(t/36e5),m:Math.floor(t/6e4)%60,s:Math.floor(t/1e3)%60,hs:Math.floor(t/100)%10};break;case"m":var a={m:Math.floor(t/6e4),s:Math.floor(t/1e3)%60,hs:Math.floor(t/100)%10};break;case"s":a={s:Math.floor(t/1e3),hs:Math.floor(t/100)%10};break;case"hs":a={hs:Math.floor(t/100)}}return e.each(a,function(t,i){e.inArray(i,["h","m","s"])&&10>t&&(a[i]=""+("0"+t)),a[i]=""+a[i]}),i.get("interval")>=1e3&&delete a.hs,a},destructor:function(){this._ajustHandler&&(this._ajustHandler.cancel(),this._ajustHandler=null),this._timerHandler&&(this._timerHandler.cancel(),this._timerHandler=null)}}),a},{requires:["brix/core/brick","ajax"]});