KISSY.add("brix/gallery/searchbox/index",function(e,t,n){function u(){u.superclass.constructor.apply(this,arguments)}var r=n.all,i=e.DOM,s=e.Event,o=0;return u.ATTRS={el:{value:"#J_searchbox"},currentCls:{value:"selected"},redirect:{value:"data-redirect"},emptyAction:{value:"data-empty-action"},curItem:{value:{}},stat:{value:"data-stat-submit"},isSuggest:{value:!0},autosuggest:{value:"data-suggest-api"}},u.ATTACH={".searchbox-menu":{mouseenter:function(e){e.preventDefault();var t=this,n=t.searchObj,r=e.currentTarget;i.addClass(r,"expand"),i.height(n.menuContainer,24*n.menuItemCount+13),i.height(n.menuList,24*n.menuItemCount+10),i.addClass(n.searchboxInner,"expandmenu");var s=n.searchboxOuter;i.hasClass(s,"focus")||i.addClass(s,"focus")},mouseleave:function(e){e.preventDefault();var t=this,n=e.currentTarget;t._collapse(),t._focusInput()}},li:{click:function(e){this.tabChange(e)}},".searchbox-input":{focus:function(t){var n=this,r=t.currentTarget,s=this.searchObj.searchboxOuter;i.hasClass(s,"focus")||i.addClass(s,"focus"),i.addClass(i.prev(r),"hide");if(n.get("isSuggest")){if(n.suggest){n.detach(t.type,arguments.callee);return}var o=i.attr(n.curItem,n.get("autosuggest"));console.log(o),o&&o.indexOf("area=etao")>0&&e.use("suggest",function(){n._initSuggest(o)})}},blur:function(e){var t=e.currentTarget;t.value===""&&i.removeClass(i.prev(t),"hide");var n=this.searchObj.searchboxOuter,r=this.searchObj.menu;i.hasClass(n,"focus")&&!i.hasClass(r,"expand")&&i.removeClass(n,"focus")},keyup:function(e){var t=this;t._dealClearBtn()},keydown:function(e){e.keyCode==13&&(e.halt(!0),self.submit())}},".search-label":{click:function(e){var t=e.currentTarget;s.fire(i.next(t),"focus")}},".s-btn-clear":{click:function(e){var t=this,n=t.searchObj,r=n.input;i.val(r,""),t._hideBtn(),t._focusInput()}},".search-form":{submit:function(e){var t=this;t.submit(e)}}},u.METHOD={_focusInput:function(){var e=this,t=e.searchObj,n=t.input;n.focus()},_collapse:function(){var e=this.searchObj;i.removeClass(e.menu,"expand"),i.height(e.menuContainer,0),i.height(e.menuList,0),i.removeClass(e.searchboxInner,"expandmenu")},_dealClearBtn:function(){var e=this.searchObj.input;e.value!==""?this._showBtn():this._hideBtn()},_dealLabel:function(){var e=this.searchObj.input,t=i.prev(e);e.value===""?i.removeClass(t,"hide"):i.addClass(t,"hide")},_hideBtn:function(){var e=this.searchObj.btnClear;i.removeClass(e,"btn-show"),i.addClass(e,"btn-hide")},_showBtn:function(){var e=this.searchObj.btnClear;i.removeClass(e,"btn-hide"),i.addClass(e,"btn-show")},tabChange:function(t){var n=this,r=n.searchObj,s=t.currentTarget,o=n.get("currentCls");if(i.hasClass(s,o)){t.halt(!0);return}e.each(r.menuItems,function(e){i.removeClass(e,o)}),i.addClass(s,o),n._collapse(),i.html(r.menuSelected,i.html(i.get("a",s))+"<i></i>"),r.input.focus(),n.suggest&&(n.suggest.on("beforeStart",function(){return!1}),n.suggest=undefined),n.curItem=s;var u=e.trim(i.attr(i.get(r.menuList),n.get("redirect")))!=="false";if(!u){t.halt(!0);return}var a=i.get("a",n.curItem),f=e.trim(i.attr(a,n.get("emptyAction")));r.input.value!==""?(t.halt(!0),n.submit()):f?i.get("a",n.curItem).href=f:t.halt(!0)},submit:function(t){var n=this,r=n.searchObj,s=i.get("a",n.curItem),o=e.trim(i.attr(s,n.get("emptyAction")));if(r.input.value==="")o?(r.input.value="",n.action=o,r.searchForm.submit()):(t.halt(!0),r.input.focus());else{n.action=i.attr(s,"href"),n._parseAction(n.action);var u=i.attr(s,n.get("stat"));e.trim(u),r.searchForm.submit()}},_parseAction:function(t){if(t.indexOf("?")!==-1){var n=t.substring(t.indexOf("?")+1,t.length).split("&");for(var r=0,i=n.length;r<i;r++){if(e.trim(n[r])==="")continue;var s=n[r].split("=");this._writeHiddenInput(this.searchObj.searchForm,s[0],s[1])}}},_writeHiddenInput:function(e,t,n){var r=e[t];return r?r.value=n:(r=i.create('<input type="hidden" name="'+t+'" value="'+n+'" />'),e.appendChild(r)),r},_initSuggest:function(t){var n=this,r=n.searchObj,s=n.get("stat");n.suggest=new e.Suggest(r.input,t,{resultFormat:"%result%",offset:0}),n.suggest.on("dataReturn",function(e){n.suggest.etaobook=e.data.etaobook,n.suggest.results=e.data.result}),n.suggest.on("beforeShow",function(){var t=n.suggest.etaobook,r="";t&&t.length>0&&(e.each(t,function(e,n){r+='<li class="ks-suggest-extra" key="'+t[n][0]+'" data-epid="'+t[n][1]+'"><span class="ks-suggest-key">'+t[n][0]+'</span><span class="suggest-star">\u2605</span><span class="suggest-author">'+t[n][2]+'</span><span class="suggest-pub">'+t[n][3]+'</span><span class="suggest-time">'+t[n][4]+"</span></li>"}),n.suggest.results.length===0&&i.html(n.suggest.content,"<ol></ol>"),r&&i.append(i.create(r),n.suggest.content.firstChild)),n._keyword()}),n.suggest.on("itemSelect",function(){var t=this.selectedItem,o=i.query("li",this.containers),u={};u.q=this.query,u.wq=i.attr(t,"key"),u.n=e.indexOf(t,o);var a=i.get("a",n.curItem);i.attr(a,s,i.attr(a,s)+"&"+e.param(u));var f=i.attr(t,"data-epid");f&&(n._writeHiddenInput(r.searchForm,"epid",f),n._writeHiddenInput(r.searchForm,"v","product"),n._writeHiddenInput(r.searchForm,"p","detail"))})},_keyword:function(){var t=this,n=t.suggest,r=n.query,s=r.length;e.each(i.query("li",n.content),function(e){var t=i.get(".ks-suggest-key",e),n=i.html(t);n.indexOf(r)===0&&i.html(t,n.substring(0,s)+"<b>"+n.substring(s,n.length)+"</b>")})}},e.extend(u,t,{initialize:function(){var e=this,t=i.get(e.get("el")),n=i.get(".searchbox-menu",t),r=i.get(".searchbox-input",t),s=i.query("li",n);e.searchObj={searchbox:t,searchForm:i.get("form",t),menu:n,menuSelected:i.get(".s-menu-selected",n),menuContainer:i.get(".s-menu-container",n),menuList:i.get(".s-menu-list",n),menuItems:s,searchboxOuter:i.get(".searchbox-outer",t),searchboxInner:i.get(".searchbox-inner",t),input:r,btnClear:i.get(".s-btn-clear",t),menuItemCount:i.query("li",n).length},e.curItem=i.filter(s,"."+e.get("currentCls"))[0],e._dealClearBtn();var o="autofocus"in document.createElement("input"),u=i.attr(r,"data-autofocus"),a=u=="autofocus"||u==1;(!o||!a)&&e._dealLabel(),a&&r.focus()},destructor:function(){}}),e.augment(u,u.METHOD),u},{requires:["brix/core/brick","node"]});