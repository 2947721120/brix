KISSY.add("brix/gallery/timer/index",function(a,b){function d(){d.superclass.constructor.apply(this,arguments)}function i(b){var c={container:null,type:"down",htmlTemplate:""};this.config=a.merge(c,b||{})}function j(b){var c={htmlTemplate:"\u524d\u964d\u4ef7"};this.config=a.merge(c,b||{}),j.superclass.constructor.call(this,this.config),this._init()}function k(b){var c={timeEnd:0,timeCurrent:0,timeLeft:0,leadingZero:!0,style:"units",days:/%\{d\}/,hours:/%\{h\}/,mins:/%\{m\}/,secs:/%\{s\}/,interval:1e3};this.config=a.merge(c,b||{}),k.superclass.constructor.call(this,this.config);var d={units:'<span class="timer-ux '+(this.config.bold?"timer-bold ":"")+(this.config.highlight?"timer-highlight ":"")+'"><span class="timer-title">\u5269\u4f59\uff1a</span>'+'<span class="timer-days timer-num">%{d}</span>\u5929<span class="timer-hours  timer-num">%{h}</span>\u65f6'+'<span class="timer-mins  timer-num">%{m}</span>\u5206<span class="timer-secs  timer-num">%{s}</span>\u79d2</span>',simple:'<span class="timer-ux '+(this.config.bold?"timer-bold ":"")+(this.config.highlight?"timer-highlight ":"")+'"><span class="timer-title">\u5269\u4f59\uff1a</span>'+'<span class="timer-hours  timer-num">%{h}</span><span class="timer-num">:</span>'+'<span class="timer-mins  timer-num">%{m}</span><span class="timer-num">:</span>'+'<span class="timer-secs  timer-num">%{s}</span></span>'};this.config.htmlTemplate=d[this.config.style],this._init()}var a=KISSY,c=a.all;d.ATTRS={mode:{value:"down"},timeEnd:{value:0},timeLeft:{value:0},updateTime:{value:0},style:{value:"units"},bold:{value:!1},highlight:{value:!1},needAjusted:{value:!1},ajustTime:{value:36e5}};var e=864e5,f=[],g={years:"\u5e74",months:"\u6708",days:"\u5929",hours:"\u5c0f\u65f6",mins:"\u5206\u949f",secs:"\u79d2"},h=function(a,b){var c=a.getTime();return a.setUTCMonth(a.getUTCMonth()+b),Math.round((a.getTime()-c)/e)};i.prototype={_init:function(){this._container=c(this.config.container);if(!this._validate())return;var a=this._populate(),b=this._getInterval(a);this.render(a),this._startCount(b)},_startCount:function(){},_validate:function(){},_populate:function(){},_getInterval:function(){},render:function(){},calibrate:function(a){},_getCheckedTime:function(){var a=this._offsetTime||0;return new Date((new Date).getTime()+a)}},a.extend(j,i,{_startCount:function(a){function d(){var c=b._populate(),e=b._getCheckedTime();a=b._getInterval(c),b.render(c),b._timerHandler=setTimeout(d,a)}var b=this,c=(new Date).getTime(),a=a;b._timerHandler=setTimeout(d,a)},_validate:function(){var a=this.config;if(!this._container.length)return;if(!a.updateTime)return;var b=this._getCheckedTime();if(b.getTime()<a.updateTime)return;return!0},_populate:function(){var a=this.config.updateTime,b=this._getCheckedTime(),c,c,d,e,f,g,h,i=Math.floor,j=parseInt((b.getTime()-a)/1e3),k=new Date(a);return j<=0?(h=0,g=0,f=0,d=0,e=0):(h=b.getFullYear()-k.getFullYear(),g=b.getMonth()-k.getMonth(),c=i(j/3600),f=i(c/24),c=c%24,d=i(j/60%60),e=j%60),{years:h,months:g,days:f,hours:c,mins:d,secs:e}},_getInterval:function(a){var b=this.config.type,c=new Date,d={years:31104e6,months:h(new Date(c.getFullYear(),c.getMonth(),15),1)*24*3600*1e3,days:864e5,hours:36e5,mins:6e4,secs:1e3};return this.unit=this.pruneUnits(a),d[this.unit]},pruneUnits:function(a){return a.years>=1?"years":a.years<1&&a.months>=1?"months":a.days>=1?"days":a.hours>=1?"hours":a.mins>=1?"mins":a.secs>=1?"secs":"secs"},render:function(a){var b=a[this.unit]+g[this.unit]+this.config.htmlTemplate;this._container.html(b)},calibrate:function(a){this._offsetTime=a-(new Date).getTime(),this._timerHandler&&(clearTimeout(self._timerHandler),this._init())}}),a.extend(k,i,{_startCount:function(a){function e(){b._leftTime--;var c=b._populate();if(b._leftTime<0){b.config.callback&&b.config.callback.call(b),d.remove(b);return}b.render(c),b._timerHandler=setTimeout(e,a)}var b=this,c=(new Date).getTime(),a=b.config.interval;setTimeout(e,a)},_validate:function(){var a=this.config;if(!this._container.length)return;if(!a.timeEnd&&!a.timeLeft)return;var b=new Date;a.timeCurrent||(a.timeCurrent=b.getTime()),this._leftTime=a.timeLeft||a.timeEnd-a.timeCurrent;if(this._leftTime<0)return;return this._leftTime=parseInt(this._leftTime/1e3),!0},_populate:function(){var a,a,b,c,d,e=Math.floor,f=this._leftTime;a=e(f/3600),d=e(a/24),a=a%24,b=e(f/60%60),c=f%60,this.config.style=="simple"&&(d=0,a=e(f/3600),b=e(f/60%60),c=f%60),a<10&&(a="0"+a),b<10&&(b="0"+b),c<10&&(c="0"+c);var g=new Date;return{days:d,hours:a,mins:b,secs:c}},_getInterval:function(a){return this.config.interval},render:function(a){var b=this.config,c=KISSY.all,d;this.isShowed?(c(".timer-days",this._container).html(a.days),c(".timer-hours",this._container).html(a.hours),c(".timer-mins",this._container).html(a.mins),c(".timer-secs",this._container).html(a.secs)):(d=b.htmlTemplate.replace(b.days,a.days).replace(b.hours,a.hours).replace(b.mins,a.mins).replace(b.secs,a.secs),this._container.html(d),this.isShowed=!0)},calibrate:function(a){if(this._leftTime<=0)return!1;var a=Math.floor(a/1e3);return this._timeOffset?this._leftTime=this._timeOffset-a:this._timeOffset=a+this._leftTime,!0}});var l={_checkerRunner:null,_status:0,init:function(b){if(this._status)return;var c=b||36e5,d=this;this._checkerRunner=setInterval(function(){function i(a,b,h){c=new Date(h.getResponseHeader("Date")),e=c.getTime(),g=(new Date).getTime(),d._calibrater(e+(g-f)/2)}var b,c,e,f=(new Date).getTime(),g,h=window.location.protocol+"//"+window.location.host+"?t="+ +(new Date);a.io({type:"head",url:h,success:i})},c),d._status=1},_calibrater:function(b){if(this._serverDate==b)return;a.each(f,function(a,c){a&&a.calibrate(b)}),this._serverDate=b,f.length||this._clearChecker()},_clearChecker:function(){try{clearInterval(this._checkerRunner)}catch(a){}this._status=0}};return d.create=function(a){var b;a.needAjusted&&l.init(a.ajustTime);switch(a.type){case"down":b=new k(a);break;case"up":b=new j(a)}return f.push(b),b},d.remove=function(a){for(var b=0,c=f.length;b<c;b++)if(f[b]==a)return f.splice(b,1)},a.extend(d,b,{initialize:function(){d.create({container:this.get("el"),type:this.get("mode"),timeLeft:this.get("timeLeft"),timeEnd:this.get("timeEnd"),updateTime:this.get("updateTime"),style:this.get("style"),highlight:this.get("highlight"),bold:this.get("bold"),needAjusted:this.get("needAjusted"),ajustTime:this.pagelet.get("ajustTime")||this.get("ajustTime")})}}),d},{requires:["brix/core/brick"]});