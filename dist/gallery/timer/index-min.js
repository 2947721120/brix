KISSY.add("brix/gallery/timer/index",function(e,t){function r(){r.superclass.constructor.apply(this,arguments)}function a(t){var n={container:null,type:"down",htmlTemplate:""};this.config=e.merge(n,t||{})}function f(t){var n={htmlTemplate:"\u524d\u964d\u4ef7"};this.config=e.merge(n,t||{}),f.superclass.constructor.call(this,this.config),this._init()}function l(t){var n={timeEnd:0,timeCurrent:0,timeLeft:0,leadingZero:!0,style:"units",days:/%\{d\}/,hours:/%\{h\}/,mins:/%\{m\}/,secs:/%\{s\}/,interval:1e3};this.config=e.merge(n,t||{}),l.superclass.constructor.call(this,this.config);var r={units:'<span class="timer-ux '+(this.config.bold?"timer-bold ":"")+(this.config.highlight?"timer-highlight ":"")+'"><span class="timer-title">\u5269\u4f59\uff1a</span>'+'<span class="timer-days timer-num">%{d}</span>\u5929<span class="timer-hours  timer-num">%{h}</span>\u65f6'+'<span class="timer-mins  timer-num">%{m}</span>\u5206<span class="timer-secs  timer-num">%{s}</span>\u79d2</span>',simple:'<span class="timer-ux '+(this.config.bold?"timer-bold ":"")+(this.config.highlight?"timer-highlight ":"")+'"><span class="timer-title">\u5269\u4f59\uff1a</span>'+'<span class="timer-hours  timer-num">%{h}</span><span class="timer-num">:</span>'+'<span class="timer-mins  timer-num">%{m}</span><span class="timer-num">:</span>'+'<span class="timer-secs  timer-num">%{s}</span></span>'};this.config.htmlTemplate=r[this.config.style],this._init()}var e=KISSY,n=e.all;r.ATTRS={mode:{value:"down"},timeEnd:{value:0},timeLeft:{value:0},updateTime:{value:0},style:{value:"units"},bold:{value:!1},highlight:{value:!1},needAjusted:{value:!1},ajustTime:{value:36e5}};var i=864e5,s=[],o={years:"\u5e74",months:"\u6708",days:"\u5929",hours:"\u5c0f\u65f6",mins:"\u5206\u949f",secs:"\u79d2"},u=function(e,t){var n=e.getTime();return e.setUTCMonth(e.getUTCMonth()+t),Math.round((e.getTime()-n)/i)};a.prototype={_init:function(){this._container=n(this.config.container);if(!this._validate())return;var e=this._populate(),t=this._getInterval(e);this.render(e),this._startCount(t)},_startCount:function(){},_validate:function(){},_populate:function(){},_getInterval:function(){},render:function(){},calibrate:function(e){},_getCheckedTime:function(){var e=this._offsetTime||0;return new Date((new Date).getTime()+e)}},e.extend(f,a,{_startCount:function(e){function r(){var n=t._populate(),i=t._getCheckedTime();e=t._getInterval(n),t.render(n),t._timerHandler=setTimeout(r,e)}var t=this,n=(new Date).getTime(),e=e;t._timerHandler=setTimeout(r,e)},_validate:function(){var e=this.config;if(!this._container.length)return;if(!e.updateTime)return;var t=this._getCheckedTime();if(t.getTime()<e.updateTime)return;return!0},_populate:function(){var e=this.config.updateTime,t=this._getCheckedTime(),n,n,r,i,s,o,u,a=Math.floor,f=parseInt((t.getTime()-e)/1e3),l=new Date(e);return f<=0?(u=0,o=0,s=0,r=0,i=0):(u=t.getFullYear()-l.getFullYear(),o=t.getMonth()-l.getMonth(),n=a(f/3600),s=a(n/24),n%=24,r=a(f/60%60),i=f%60),{years:u,months:o,days:s,hours:n,mins:r,secs:i}},_getInterval:function(e){var t=this.config.type,n=new Date,r={years:31104e6,months:u(new Date(n.getFullYear(),n.getMonth(),15),1)*24*3600*1e3,days:864e5,hours:36e5,mins:6e4,secs:1e3};return this.unit=this.pruneUnits(e),r[this.unit]},pruneUnits:function(e){return e.years>=1?"years":e.years<1&&e.months>=1?"months":e.days>=1?"days":e.hours>=1?"hours":e.mins>=1?"mins":e.secs>=1?"secs":"secs"},render:function(e){var t=e[this.unit]+o[this.unit]+this.config.htmlTemplate;this._container.html(t)},calibrate:function(e){this._offsetTime=e-(new Date).getTime(),this._timerHandler&&(clearTimeout(self._timerHandler),this._init())}}),e.extend(l,a,{_startCount:function(e){function i(){t._leftTime--;var n=t._populate();if(t._leftTime<0){t.config.callback&&t.config.callback.call(t),r.remove(t);return}t.render(n),t._timerHandler=setTimeout(i,e)}var t=this,n=(new Date).getTime(),e=t.config.interval;setTimeout(i,e)},_validate:function(){var e=this.config;if(!this._container.length)return;if(!e.timeEnd&&!e.timeLeft)return;var t=new Date;e.timeCurrent||(e.timeCurrent=t.getTime()),this._leftTime=e.timeLeft||e.timeEnd-e.timeCurrent;if(this._leftTime<0)return;return this._leftTime=parseInt(this._leftTime/1e3),!0},_populate:function(){var e,e,t,n,r,i=Math.floor,s=this._leftTime;e=i(s/3600),r=i(e/24),e%=24,t=i(s/60%60),n=s%60,this.config.style=="simple"&&(r=0,e=i(s/3600),t=i(s/60%60),n=s%60),e<10&&(e="0"+e),t<10&&(t="0"+t),n<10&&(n="0"+n);var o=new Date;return{days:r,hours:e,mins:t,secs:n}},_getInterval:function(e){return this.config.interval},render:function(e){var t=this.config,n=KISSY.all,r;this.isShowed?(n(".timer-days",this._container).html(e.days),n(".timer-hours",this._container).html(e.hours),n(".timer-mins",this._container).html(e.mins),n(".timer-secs",this._container).html(e.secs)):(r=t.htmlTemplate.replace(t.days,e.days).replace(t.hours,e.hours).replace(t.mins,e.mins).replace(t.secs,e.secs),this._container.html(r),this.isShowed=!0)},calibrate:function(e){if(this._leftTime<=0)return!1;var e=Math.floor(e/1e3);return this._timeOffset?this._leftTime=this._timeOffset-e:this._timeOffset=e+this._leftTime,!0}});var c={_checkerRunner:null,_status:0,init:function(t){if(this._status)return;var n=t||36e5,r=this;this._checkerRunner=setInterval(function(){function a(e,t,u){n=new Date(u.getResponseHeader("Date")),i=n.getTime(),o=(new Date).getTime(),r._calibrater(i+(o-s)/2)}var t,n,i,s=(new Date).getTime(),o,u=window.location.protocol+"//"+window.location.host+"?t="+ +(new Date);e.io({type:"head",url:u,success:a})},n),r._status=1},_calibrater:function(t){if(this._serverDate==t)return;e.each(s,function(e,n){e&&e.calibrate(t)}),this._serverDate=t,s.length||this._clearChecker()},_clearChecker:function(){try{clearInterval(this._checkerRunner)}catch(e){}this._status=0}};return r.create=function(e){var t;e.needAjusted&&c.init(e.ajustTime);switch(e.type){case"down":t=new l(e);break;case"up":t=new f(e)}return s.push(t),t},r.remove=function(e){for(var t=0,n=s.length;t<n;t++)if(s[t]==e)return s.splice(t,1)},e.extend(r,t,{initialize:function(){r.create({container:this.get("el"),type:this.get("mode"),timeLeft:this.get("timeLeft"),timeEnd:this.get("timeEnd"),updateTime:this.get("updateTime"),style:this.get("style"),highlight:this.get("highlight"),bold:this.get("bold"),needAjusted:this.get("needAjusted"),ajustTime:this.pagelet.get("ajustTime")||this.get("ajustTime")})}}),r},{requires:["brix/core/brick"]});