KISSY.add("brix/gallery/calendar/index",function(a,b,c,d,e){function f(){f.superclass.constructor.apply(this,arguments)}return f.ATTRS={date:{value:new Date},selected:{value:null},startDay:{value:0},pages:{value:1},closable:{value:!1},rangeSelect:{value:!1},minDate:{value:!1},maxDate:{value:!1},multiSelect:{value:!1},multi:{value:null,setter:function(a){for(var b=0;b<a.length;b++)a[b]instanceof Date&&(a[b]=e.format(a[b],"isoDate"));return a}},navigator:{value:!0},popup:{value:!1},showTime:{value:!1},triggerType:{value:["click"]},disabled:{value:!1},range:{value:!1},rangeLinkage:{value:!0},align:{value:{points:["bl","tl"],offset:[0,0]}},notLimited:{value:!1},autoRender:{value:!0},tmpl:{valueFn:function(){var b=this,c=b.get("id")||"brix_calendar_"+a.guid();return'<div id="'+c+'" bx-name="calendar" class="calendar">'+'<div class="calendar-pages"></div>'+'<div bx-tmpl="calendar" bx-datakey="notLimited,multiSelect,showTime,'+c+'_op_html" class="calendar-operator">{{{'+c+"_op_html}}}</div>"+"</div>"}},data:{valueFn:function(){return{notLimited:this.get("notLimited")}}}},f.FIRES={select:"select",monthChange:"monthChange",timeSelect:"timeSelect",rangeSelect:"rangeSelect",multiSelect:"multiSelect",show:"show",hide:"hide"},f.RENDERER={op:{html:function(a){var b=a,c=b.get("notLimited"),d=b.get("showTime"),e=b.get("multiSelect"),f="";if(d||e)f+='<a class="btn btn-calendar-confirm">\u786e\u5b9a</a>';return c&&(f+='<a class="btn btn-calendar-notlimited">\u4e0d\u9650</a>'),f}}},f.DOCATTACH={"":{click:function(b){var c=this,d=c.get("el"),e=a.one(b.target),f=a.one(c.get("trigger"));!d.contains(e)&&e[0]!=f[0]&&c.hide()}}},f.ATTACH={".btn-calendar-confirm":{click:function(b){var c=this,d=c.get("selected"),g=c.get("showTime"),h=c.get("multiSelect");if(h){var i=a.clone(c.get("multi"));i.sort(function(a,b){return a>b?1:-1});for(var j=0;j<i.length;j++)i[j]=e.parse(i[j]);a.log(i),c.fire(f.FIRES.multiSelect,{multi:i})}else if(g){var k=new Date;d&&(k=d);var l=c.pageBricks[0].timeBrick.get("time");k.setHours(l.getHours()),k.setMinutes(l.getMinutes()),k.setSeconds(l.getSeconds()),a.log(k),c.fire(f.FIRES.timeSelect,{date:k})}c.hide()}},".btn-calendar-notlimited":{click:function(a){var b=this,c=b.get("notLimited");c&&b.fire(f.FIRES.select,{date:null})}}},f.METHOD={align:function(){var b=this,c=a.clone(b.get("align")),d=a.one(b.get("trigger"));c.node=d,b.overlay.set("align",c)},show:function(){var a=this;a.overlay&&(a.align(),a.overlay.show(),a.fire(f.FIRES.show))},hide:function(){var a=this;a.overlay&&(a.overlay.hide(),a.fire(f.FIRES.hide))},toggle:function(){var a=this;a.overlay&&(a.overlay.get("el").css("visibility")=="hidden"?a.show():a.hide())}},a.extend(f,b,{initialize:function(){var b=this,e=b.get("popup"),g=b.get("closable"),h=b.get("pages"),i=b.get("rangeLinkage"),j=b.get("el"),k=b.get("date"),l=k.getMonth(),m=k.getFullYear(),n=a.one(b.get("trigger"));if(e){var o=a.clone(b.get("align"));o.node=n,b.overlay=new c({srcNode:"#"+b.get("id"),align:o}),b.overlay.render();var p=b.get("triggerType");a.each(p,function(a){n.on(a,function(){b.toggle()})})}else j.css({position:"static",visibility:"visible"}),n.append(j);var q=j.one(".calendar-pages");b.pageBricks=[],j.addClass(".calendar-"+h);var r,s;for(var t=0;t<h;t++)i?(r=t==0,s=t==h-1):(r=!0,s=!0),function(a){var c=new d({id:b.get("id")+"page"+a,index:a,prev:r,next:s,year:m,month:l,father:b,container:q});b.pageBricks.push(c),c.on("itemClick",function(a){var c=b.get("rangeSelect");c?b._handleRange(a.date):a.date&&(b.set("selected",a.date),b.fire(f.FIRES.select,{date:a.date}),e&&g&&!b.get("showTime")&&b.hide())}),c.on("itemMouseDown",function(a){var c=b.get("multiSelect");c&&b._handleMultiSelectStart(a.date)}),c.on("itemMouseUp",function(a){var c=b.get("multiSelect");c&&b._handleMultiSelectEnd(a.date)}),c.on("monthChange",function(a){var c=b.get("rangeLinkage"),d=a.index;m=a.date.getFullYear(),l=a.date.getMonth();if(c){for(var e=0;e<b.pageBricks.length;e++){var g=l-d+e,h=m;g<0?(h--,g+=12):g>11&&(h++,g-=12),b.pageBricks[e].set("year",h),b.pageBricks[e].set("month",g)}var i=m,j=l-d;j<0&&(i--,j+=12),b.fire(f.FIRES.monthChange,{date:new Date(i,j,1)})}else b.pageBricks[d].set("year",m),b.pageBricks[d].set("month",l),b.fire(f.FIRES.monthChange,{date:new Date(m,l,1)})})}(t),l==11?(m++,l=0):l++;b._bindDataChange("range"),b._bindDataChange("multi"),b._bindDataChange("disabled"),b._bindDataChange("minDate"),b._bindDataChange("maxDate"),b._bindDataChange("selected"),b._bindDataChange("startDay")},destructor:function(){var b=this;b.overlay?b.overlay.destroy():a.one(b.get("trigger")).empty()},_bindDataChange:function(a,b){var c=this,b=a.replace(/\b(\w)|\s(\w)/g,function(a){return a.toUpperCase()});c.on("after"+b+"Change",function(){var b=c.get(a);for(var d=0;d<c.pageBricks.length;d++)c.pageBricks[d].setChunkData(a,b)})},_handleRange:function(b){var c=this,d=a.clone(c.get("range"))||{},e;if(!d.start&&!d.end||d.start&&d.end)d.start=b,d.end=null,c.set("range",d);else{d.end=b,d.start.getTime()>d.end.getTime()&&(e=d.start,d.start=d.end,d.end=e),c.set("range",d),c.fire("rangeSelect",d);var f=c.get("popup"),g=c.get("closable");f&&g&&c.hide()}},_handleMultiSelectStart:function(a){this.multiStartDate=a},_handleMultiSelectEnd:function(b){if(this.multiStartDate){var c=this,d=a.clone(c.get("multi"))||[],f=c.multiStartDate,g,h=c.get("minDate"),i=c.get("maxDate"),j=c.get("disabled");b<f?(g=f,f=b):g=b;while(f<=g){if(e.isDisabled(j,f))continue;var k=e.format(f,"isoDate");a.inArray(k,d)?d.splice(a.indexOf(k,d),1):d.push(k),f.setDate(f.getDate()+1)}delete c.multiStartDate,c.set("multi",d)}}}),a.augment(f,f.METHOD),f},{requires:["brix/core/brick","overlay","./page","./date"]});