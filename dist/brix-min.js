/*! Brix - v0.1.0
* https://github.com/etaoux/brix
* Copyright (c) 2012 etaoux; Licensed MIT */
KISSY.config({packages:[{name:"brix",tag:"20120904",path:"http://a.tbcdn.cn/p/",charset:"utf-8"}]}),KISSY.add("brix/core/mustache",function(e){var t=typeof module!="undefined"&&module.exports||{};return function(e){function a(e){return u.test(e)}function p(e){return String(e).replace(/&(?!\w+;)|[<>"']/g,function(e){return h[e]||e})}function d(e,t,n,r){r=r||"<template>";var i=t.split("\n"),s=Math.max(n-3,0),o=Math.min(i.length,n+3),u=i.slice(s,o),a;for(var f=0,l=u.length;f<l;++f)a=f+s+1,u[f]=(a===n?" >> ":"    ")+u[f];return e.template=t,e.line=n,e.file=r,e.message=[r+":"+n,u.join("\n"),"",e.message].join("\n"),e}function v(e,t,n){if(e===".")return t[t.length-1];var r=e.split("."),i=r.length-1,s=r[i],o,u,a=t.length,f,l;while(a){l=t.slice(0),u=t[--a],f=0;while(f<i){u=u[r[f++]];if(u==null)break;l.push(u)}if(u&&typeof u=="object"&&s in u){o=u[s];break}}return typeof o=="function"&&(o=o.call(l[l.length-1])),o==null?n:o}function m(e,t,n,r){var i="",u=v(e,t);if(r){if(u==null||u===!1||s(u)&&u.length===0)i+=n()}else if(s(u))o(u,function(e){t.push(e),i+=n(),t.pop()});else if(typeof u=="object")t.push(u),i+=n(),t.pop();else if(typeof u=="function"){var a=t[t.length-1],f=function(e){return S(e,a)};i+=u.call(a,n(),f)||""}else u&&(i+=n());return i}function g(t,n){n=n||{};var r=n.tags||e.tags,i=r[0],s=r[r.length-1],o=['var buffer = "";',"\nvar line = 1;","\ntry {",'\nbuffer += "'],u=[],l=!1,c=!1,h=function(){if(l&&!c&&!n.space)while(u.length)o.splice(u.pop(),1);else u=[];l=!1,c=!1},p=[],v,m,g,y=function(e){r=f(e).split(/\s+/),m=r[0],g=r[r.length-1]},b=function(e){o.push('";',v,'\nvar partial = partials["'+f(e)+'"];',"\nif (partial) {","\n  buffer += render(partial,stack[stack.length - 1],partials);","\n}",'\nbuffer += "')},w=function(e,r){var i=f(e);if(i==="")throw d(new Error("Section name may not be empty"),t,N,n.file);p.push({name:i,inverted:r}),o.push('";',v,'\nvar name = "'+i+'";',"\nvar callback = (function () {","\n  return function () {",'\n    var buffer = "";','\nbuffer += "')},E=function(e){w(e,!0)},S=function(e){var r=f(e),i=p.length!=0&&p[p.length-1].name;if(!i||r!=i)throw d(new Error('Section named "'+r+'" was never opened'),t,N,n.file);var s=p.pop();o.push('";',"\n    return buffer;","\n  };","\n})();"),s.inverted?o.push("\nbuffer += renderSection(name,stack,callback,true);"):o.push("\nbuffer += renderSection(name,stack,callback);"),o.push('\nbuffer += "')},x=function(e){o.push('";',v,'\nbuffer += lookup("'+f(e)+'",stack,"");','\nbuffer += "')},T=function(e){o.push('";',v,'\nbuffer += escapeHTML(lookup("'+f(e)+'",stack,""));','\nbuffer += "')},N=1,C,k;for(var L=0,A=t.length;L<A;++L)if(t.slice(L,L+i.length)===i){L+=i.length,C=t.substr(L,1),v="\nline = "+N+";",m=i,g=s,l=!0;switch(C){case"!":L++,k=null;break;case"=":L++,s="="+s,k=y;break;case">":L++,k=b;break;case"#":L++,k=w;break;case"^":L++,k=E;break;case"/":L++,k=S;break;case"{":s="}"+s;case"&":L++,c=!0,k=x;break;default:c=!0,k=T}var O=t.indexOf(s,L);if(O===-1)throw d(new Error('Tag "'+i+'" was not closed properly'),t,N,n.file);var M=t.substring(L,O);k&&k(M);var _=0;while(~(_=M.indexOf("\n",_)))N++,_++;L=O+s.length-1,i=m,s=g}else{C=t.substr(L,1);switch(C){case'"':case"\\":c=!0,o.push("\\"+C);break;case"\r":break;case"\n":u.push(o.length),o.push("\\n"),h(),N++;break;default:a(C)?u.push(o.length):c=!0,o.push(C)}}if(p.length!=0)throw d(new Error('Section "'+p[p.length-1].name+'" was not closed properly'),t,N,n.file);h(),o.push('";',"\nreturn buffer;","\n} catch (e) { throw {error: e, line: line}; }");var D=o.join("").replace(/buffer \+= "";\n/g,"");return n.debug&&(typeof console!="undefined"&&console.log?console.log(D):typeof print=="function"&&print(D)),D}function y(e,t){var n="view,partials,stack,lookup,escapeHTML,renderSection,render",r=g(e,t),i=new Function(n,r);return function(n,r){r=r||{};var s=[n];try{return i(n,r,s,v,p,m,S)}catch(o){throw d(o.error,e,o.line,t.file)}}}function w(){b={}}function E(e,t){return t=t||{},t.cache!==!1?(b[e]||(b[e]=y(e,t)),b[e]):y(e,t)}function S(e,t,n){return E(e)(t,n)}e.name="mustache.js",e.version="0.5.0-dev",e.tags=["{{","}}"],e.parse=g,e.compile=E,e.render=S,e.clearCache=w,e.to_html=function(e,t,n,r){var i=S(e,t,n);if(typeof r!="function")return i;r(i)};var t=Object.prototype.toString,n=Array.isArray,r=Array.prototype.forEach,i=String.prototype.trim,s;n?s=n:s=function(e){return t.call(e)==="[object Array]"};var o;r?o=function(e,t,n){return r.call(e,t,n)}:o=function(e,t,n){for(var r=0,i=e.length;r<i;++r)t.call(n,e[r],r,e)};var u=/^\s*$/,f;if(i)f=function(e){return e==null?"":i.call(e)};else{var l,c;a("\u00a0")?(l=/^\s+/,c=/\s+$/):(l=/^[\s\xA0]+/,c=/[\s\xA0]+$/),f=function(e){return e==null?"":String(e).replace(l,"").replace(c,"")}}var h={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},b={}}(t),t}),KISSY.add("brix/core/mu",function(e,t){function n(e,t){var n=r(e),s="";for(var o=0;o<n.length;o++){s="if("+n[o]+")";if(t[s])continue;t[s]=i(n[o])}}function r(e){var t=/\{{2,3}[\^#]?if\((.*?)\)\}{2,3}?/ig,n=/\{{2,3}[\^#]?if\((.*?)\)\}{2,3}?/i,r=e.match(t),i=[];if(r)for(var s=0;s<r.length;s++)i.push(r[s].match(n)[1]);return i}function i(e){e=e.split("==");var t=function(){var t=e[0].split("."),n=e[1],r=this;for(var i=t.length-1;i>-1;i--){var s=t.slice(i),o=r;try{for(var u=0;u<s.length-1;u++)o=o[s[u]];if(s[s.length-1]in o)return o[s[s.length-1]].toString()===n?!0:!1}catch(a){}}return!1};return t}function s(e,t){var n,r;for(n in e)r=e[n],r instanceof Array?o(r):typeof r=="object"&&t<5&&s(r,t+1)}function o(e){for(var t=0;t<e.length;t++){var n=e[t];typeof n=="object"&&(t===0?n.__first__=!0:t===e.length-1?n.__last__=!0:n.__mid__=!0,n.__index__=t)}}return{to_html:function(e,r){return typeof r=="object"&&s(r,0),n(e,r),t.to_html.apply(this,arguments)},name:t.name,version:t.version,tags:t.tags,parse:t.parse,compile:t.compile,render:t.render,clearCache:t.clearCache}},{requires:["./mustache"]}),KISSY.add("brix/core/tmpler",function(S,Mustache,Node,UA){function _stamp(e,t){return t=t||"brick_",e.attr("id")||e.attr("id",S.guid("brix_"+t)),e.attr("id")}function _inDom(e){return e.parentNode&&e.parentNode.nodeType!=11}function _recovery(e,t){return e=e.replace(/(\{{2,3}[\^#~](.+?)\}{2,3})\=\"\"/g,"$1"),e=e.replace(/(\{{2,3}[\^#~]?)iftmplbrick\_(\d+)(\}{2,3})/g,function(e,n,r,i){return n+t[parseInt(r,10)]+i}),e=e.replace(/(href|src|style)=("|')("|')/ig,""),e=e.replace(/(\{{2,3}[\^#~]?)href\_src\_style\_tmplbrick\_(\d+)(\}{2,3})/g,function(e,n,r,i){return t[parseInt(r,10)]}),e=e.replace(/(\{{2,3})~/g,"$1/"),e}function Tmpler(e,t){e&&t!==!1?(this.bricks={},this._praseTmpl(e)):this.tmpl=e}var $=Node.all;return S.extend(Tmpler,Object,{_praseTmpl:function(e){this._buildBricks(e)},_buildBricks:function(e){var t=this,n=!1,r=$(e),i;r.item(0)[0].tagName.toUpperCase()=="SCRIPT"?e=r.item(0).html():n=_inDom(r[0]);if(!n){var s=/(\{{2,3}\#(.+?)\}{2,3})\s*([\s\S]*)?\s*((\{{2,3})\/\2(\}{2,3}))/g;while(s.test(e))e=e.replace(s," $1$3$5~$2$6 "),s.lastIndex=0;var o=[];e=e.replace(/(\{{2,3}[\^#~])?(if\(.*?\))(\}{2,3})?/ig,function(e,t,n,r,i,s){var u=S.indexOf(n,o),a="iftmplbrick_";return u<0?(a+=o.length,o.push(n)):a+=u,t+a+r}),e=e.replace(/((href|src|style)=("|')(.*?)("|'))/ig,function(e,t){var n=S.indexOf(t,o),r="href_src_style_tmplbrick_";return n<0?(r+=o.length,o.push(t)):r+=n,"{{#"+r+"}}"}),r=$(e),r.length>1&&(r=$("<div></div>").append(r)),i=$("<div></div>").append(r)}else i=r;this.id=_stamp(r);var u=i.all("[bx-tmpl-source]");u.each(function(e){var t=e.attr("bx-tmpl-source"),n=_stamp(e,"tmpl_"),r=i.one(t).clone(!0);r.removeAttr("id"),r.insertBefore(e),e.remove(),r.attr("id",n)});var a=i.all("[bx-name]:not([bx-parent])");a.each(function(e){t._buildBrick(e,i,t.bricks,o)}),n||(t.tmpl=_recovery(i.html(),o),r.remove(),i.remove()),i=null,r=null,this.inDom=n},_buildBrick:function(el,container,bricks,arr){var self=this,id=_stamp(el),name=el.attr("bx-name"),path=el.attr("bx-path"),config=el.attr("bx-config"),tmplNodes=container.all("[bx-tmpl="+name+"]");el.hasAttr("bx-tmpl")&&(tmplNodes=tmplNodes.add(el[0])),config=config?eval("config="+config):{},bricks[id]={name:name,path:path,config:config,tmpls:[],bricks:{}};var tmpls=bricks[id].tmpls;tmplNodes.each(function(e){var t=_stamp(e,"tmpl_"),n=e.attr("bx-datakey"),r=_recovery(e.html(),arr);tmpls.push({id:t,datakey:n?n.split(","):[],tmpler:new Tmpler(r,!1)})}),tmplNodes=null,container.all("[bx-parent="+name+"]").each(function(e){self._buildBrick(e,container,bricks[id].bricks)})},addTmpl:function(e,t){var n=this,r=!1;return S.each(n.bricks,function(n,i){if(i===e)return S.each(t,function(e){n.tmpls.push({id:e.id,datakey:e.datakey.split(","),tmpler:new Tmpler(e.tmpl,!1)})}),r=!0,!1}),r},getTmpl:function(){return this.tmpl},to_html:function(e){return Mustache.to_html(this.getTmpl(),e)}}),Tmpler},{requires:["./mu","node","ua","sizzle"]}),KISSY.add("brix/core/dataset",function(e,t){function n(){n.superclass.constructor.apply(this,arguments)}return n.ATTRS={data:{}},e.extend(n,t,{setRenderer:function(e,t,n){var r=this,i=r.get("data"),s,o;n=n?n+"_":"";if(e){var u=function(r,s){var o=n+r+"_"+s,u=e[r][s];i[o]=function(){return u.call(this,t,r)}};for(s in e)for(o in e[s])u(s,o)}}}),n},{requires:["base"]}),KISSY.add("brix/core/chunk",function(e,t,n,r,i){function o(){o.superclass.constructor.apply(this,arguments),this._buildTmpler()}var s=t.all;return o.ATTRS={id:{value:!1},el:{getter:function(t){return e.isString(t)&&(t=s(t)),t}},container:{value:"body",getter:function(t){return e.isString(t)&&(t=s(t)),t}},tmpl:{value:!1},tmpler:{value:!1},rendered:{value:!1},autoRender:{value:!1},data:{value:!1},dataset:{value:!1}},e.extend(o,n,{_buildTmpler:function(){var e=this,t=e.get("tmpler");if(!t){var n=e.get("tmpl");if(n){t=new i(n),e.set("tmpler",t);var r=e.get("id");r?e.set("el","#"+r):(e.set("id",t.id),e.set("el","#"+t.id))}}t&&e._buildDataset()},_buildDataset:function(){var t=this,n=t.get("dataset");if(!n){var i=t.get("data")||{};i=e.clone(i),n=new r({data:i}),t.set("dataset",n)}n.on("afterDataChange",function(e){t._render(e.subAttrName,e.newVal)})},addTmpl:function(e,t){var n=this,r=n.get("tmpler");return r?r.addTmpl(e,t):!1},setChunkData:function(t,n){var r=this,i=r.get("dataset");i&&(n=e.clone(n),i.set("data."+t,n))},render:function(){var e=this;if(!e.get("rendered")){var t=e.get("dataset");t&&e._render("data",t.get("data")),e.set("rendered",!0),e.fire("rendered")}},_render:function(e,t){var n=this,r=n.get("tmpler");if(r)if(e.split(".").length>1)e=e.replace(/^data\./,""),n._renderTmpl(r.bricks,e,t);else if(!r.inDom){var i=n.get("container");i.append(r.to_html(t))}},_renderTmpl:function(t,n,r){e.each(t,function(t){e.each(t.tmpls,function(t,i){var s=e.one("#"+t.id);if(s&&e.inArray(n,t.datakey)){var o={};e.each(t.datakey,function(e){var t=r,n=e.split("."),i=n.length,s=0;while(s!==i)t=t[n[s]],s++;o[n[i-1]]=t,t=null}),s.html(t.tmpler.to_html(o)),o=null}}),this._renderTmpl(t.bricks,n,r)},this)}}),o},{requires:["node","base","./dataset","./tmpler"]}),KISSY.add("brix/core/brick",function(e,t){function n(t,n){return e.isString(n)?t[n]:n}function r(){var e=this;e.pagelet=arguments[0]?arguments[0].pagelet:null,r.superclass.constructor.apply(this,arguments);var t=e.get("id"),n=e.get("tmpler"),i=e.constructor.RENDERER;if(i){var s=e.pagelet?e.pagelet:e;s.get("dataset").setRenderer(i,e,t)}e.on("rendered",function(){e.initialize(),e._bindEvent()}),e.pagelet?e.pagelet.get("rendered")?e.render():e.pagelet.on("rendered",function(){e.render()}):(e.get("autoRender")||!n||n.inDom)&&e.render()}return r.ATTACH={},r.ATTRS={events:{}},e.extend(r,t,{initialize:function(){},destructor:function(){},_detachEvent:function(){var t=this,n=t.constructor.ATTACH;n&&t._removeEvents(n);var r=t.constructor.DOCATTACH;r&&t._removeEvents(r,e.one(document)),t._undelegateEvents();var i=t.get("events");i&&this._removeEvents(i),t.destructor()},_bindEvent:function(){var t=this,n=t.constructor.ATTACH;n&&this._addEvents(n);var r=t.constructor.DOCATTACH;r&&this._addEvents(r,e.one(document)),t._delegateEvents();var i=t.get("events");i&&this._addEvents(i)},events:{},_removeEvents:function(e,t){t=t||this.get("el");for(var r in e){var i=e[r];for(var s in i){var o=n(this,i[s]);r===""?t.detach(s,o,this):t.undelegate(s,r,o,this)}}},_addEvents:function(e,t){t=t||this.get("el");for(var r in e){var i=e[r];for(var s in i){var o=n(this,i[s]);r===""?t.on(s,o,this):t.delegate(s,r,o,this)}}},_delegateEvents:function(){var e=this.events,t=this.get("el")[0],n=this;for(var r in e)(function(){var e=r;t["on"+e]=function(){var t=arguments[0]||window.event,r=t.target||t.srcElement;r.nodeType!==1&&(r=r.parentNode);var i=r.getAttribute("bx"+e);if(i){var s=i.split("|"),o,u;for(var a=0;a<s.length;a++){o=s[a].split(":"),u=o.shift();var f=o[o.length-1],l=!1;if(f==="_halt_"||f==="_preventDefault_")t.preventDefault?t.preventDefault():t.returnValue=!1,l=!0;if(f==="_halt_"||f==="_stop_")t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,l=!0;l&&o.pop(),n.events&&n.events[e]&&n.events[e][u]&&n.events[e][u].call(n,r,o)}}r=null}})()},_undelegateEvents:function(){var e=this.events,t=this.get("el")[0],n=this;for(var r in e)(function(){var e=r;t["on"+e]=null})()},destroy:function(){var t=this,n=t.get("tmpler");n&&!e.isEmptyObject(n.bricks)&&e.each(n.bricks,function(e,t){n.bricks[t].brick=null,delete n.bricks[t]});if(t.pagelet){var r=t.get("id");t.pagelet.destroy(r)}else t._detachEvent(),t.get("el").remove()}}),r},{requires:["./chunk"]}),KISSY.add("brix/core/pagelet",function(e,t){function n(){n.superclass.constructor.apply(this,arguments);var e=this;e.isReady=!1,e.brickCount=0,e.readyList=[],e.isAddBehavior=!1,(e.get("autoRender")||e.get("tmpler").inDom)&&e.ready(function(){e.render()})}return e.extend(n,t,{getBrick:function(e){return this._getBrick(e,this.get("tmpler").bricks)},_getBrick:function(t,n){var r=this,i;return e.each(n,function(e,n){if(n===t)return i=e.brick,!1;i=r._getBrick(t,e.bricks)}),i||null},addBehavior:function(){this.isAddBehavior||(this._addBehavior(this.get("tmpler").bricks),this.isAddBehavior=!0)},_addBehavior:function(t){var n=this,r=function(t,r){n.brickCount++,t.path||(t.path="brix/gallery/"+t.name+"/"),e.use(t.path,function(e,i){var s=e.merge({container:"#"+r,id:r,el:"#"+r,pagelet:n},t.config),u=new i(s);t.brick=u,n._addBehavior(t.bricks),n.brickCount--,n.brickCount===0&&n._fireReady()})};e.each(t,function(e,t){r(e,t)}),n.brickCount===0&&n._fireReady()},ready:function(e){return this.isReady?e.call(window,this):this.readyList.push(e),this},_fireReady:function(){var e=this;if(e.isReady)return;e.isReady=!0;if(e.readyList){var t,n=0;while(t=e.readyList[n++])t.call(e);e.readyList=null}},destroy:function(t){var n=this,r=n.get("el"),i=n.get("tmpler");i&&!e.isEmptyObject(i.bricks)&&n._destroyBricks(i.bricks,t),t||r.remove()},_destroyBricks:function(t,n){var r=this;e.each(t,function(e,i){if(n){if(n===i)return r._destroyBrick(e),delete t[i],!1;r._destroyBricks(e.bricks)}else r._destroyBrick(e),delete t[i]})},_destroyBrick:function(e){var t=this;e.brick&&(e.brick._detachEvent(),t._destroyBricks(e.bricks),e.brick.get("el").remove(),e.brick.pagelet=null,e.brick=null,delete e)}}),n},{requires:["./chunk"]});