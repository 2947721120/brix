KISSY.add("brix/core/tmpler",function(S,Mustache,Node,UA){function _stamp(a,b){return b=b||"brick_",a.attr("id")||a.attr("id",S.guid("brix_"+b)),a.attr("id")}function _recovery(a,b){return a=a.replace(/(\{{2,3}[\^#~](.+?)\}{2,3})\=\"\"/g,"$1"),a=a.replace(/(\{{2,3}[\^#~]?)iftmplbrick\_(\d+)(\}{2,3})/g,function(a,c,d,e){return c+b[parseInt(d,10)]+e}),a=a.replace(/(href|src|style)=("|')("|')/ig,""),a=a.replace(/(\{{2,3}[\^#~]?)href\_src\_style\_tmplbrick\_(\d+)(\}{2,3})/g,function(a,c,d,e){return b[parseInt(d,10)]}),a=a.replace(/(\{{2,3})~/g,"$1/"),a}function Tmpler(a,b){a&&b!==!1?(this.bricks={},this._praseTmpl(a)):this.tmpl=a}var $=Node.all;return S.extend(Tmpler,Object,{_praseTmpl:function(a){this._buildBricks(a)},_buildBricks:function(a){var b=this,c=!1,d,e;if(typeof a=="string"){if(a.charAt(0)==="."||a.charAt(0)==="#"||a==="body")d=$(a)}else d=a;d&&(d.item(0)[0].tagName.toUpperCase()=="SCRIPT"?a=d.item(0).html():c=!0);if(!c){var f=/(\{{2,3}\#(.+?)\}{2,3})\s*([\s\S]*)?\s*((\{{2,3})\/\2(\}{2,3}))/g;while(f.test(a))a=a.replace(f," $1$3$5~$2$6 "),f.lastIndex=0;var g=[];a=a.replace(/(\{{2,3}[\^#~])?(if\(.*?\))(\}{2,3})?/ig,function(a,b,c,d,e,f){var h=S.indexOf(c,g),i="iftmplbrick_";return h<0?(i+=g.length,g.push(c)):i+=h,b+i+d}),a=a.replace(/((href|src|style)=("|')(.*?)("|'))/ig,function(a,b){var c=S.indexOf(b,g),d="href_src_style_tmplbrick_";return c<0?(d+=g.length,g.push(b)):d+=c,"{{#"+d+"}}"}),d=$(a),d.length>1&&(d=$("<div></div>").append(d)),e=$("<div></div>").append(d)}else e=d;this.id=_stamp(d);var h=e.all("[bx-tmpl-source]");h.each(function(a){var b=a.attr("bx-tmpl-source"),c=_stamp(a,"tmpl_"),d=e.one(b).clone(!0);d.removeAttr("id"),d.insertBefore(a),a.remove(),d.attr("id",c)});var i=e.all("[bx-name]:not([bx-parent])");i.each(function(a){b._buildBrick(a,e,b.bricks,g)}),c||(b.tmpl=_recovery(e.html(),g),d.remove(),e.remove()),e=null,d=null,this.inDom=c},_buildBrick:function(el,container,bricks,arr){var self=this,id=_stamp(el),name=el.attr("bx-name"),path=el.attr("bx-path"),config=el.attr("bx-config"),tmplNodes=container.all("[bx-tmpl="+name+"]");el.hasAttr("bx-tmpl")&&(tmplNodes=tmplNodes.add(el[0])),config=config?eval("config="+config):{},bricks[id]={name:name,path:path,config:config,tmpls:[],bricks:{}};var tmpls=bricks[id].tmpls;tmplNodes.each(function(a){var b=_stamp(a,"tmpl_"),c=a.attr("bx-datakey"),d=_recovery(a.html(),arr);tmpls.push({id:b,datakey:c?c.split(","):[],tmpler:new Tmpler(d,!1)})}),tmplNodes=null,container.all("[bx-parent="+name+"]").each(function(a){self._buildBrick(a,container,bricks[id].bricks)})},addTmpl:function(a,b){var c=this,d=!1;return S.each(c.bricks,function(c,e){if(e===a)return S.each(b,function(a){c.tmpls.push({id:a.id,datakey:a.datakey.split(","),tmpler:new Tmpler(a.tmpl,!1)})}),d=!0,!1}),d},getTmpl:function(){return this.tmpl},to_html:function(a){return Mustache.to_html(this.getTmpl(),a)}}),Tmpler},{requires:["./mu","node","ua","sizzle"]});