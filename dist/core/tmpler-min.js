KISSY.add("brix/core/tmpler",function(S,Mustache,Node,UA){function _stamp(a,b){return b=b||"brick_",a.attr("id")||a.attr("id",S.guid("brix_"+b)),a.attr("id")}function _recovery(a,b){return a=a.replace(/(\{{2,3}[\^#~](.+?)\}{2,3})\=\"\"/g,"$1"),a=a.replace(/(\{{2,3}[\^#~]?)iftmplbrick\_(\d+)(\}{2,3})/g,function(a,c,d,e){return c+b[parseInt(d,10)]+e}),a=a.replace(/(href|src|style)=("|')("|')/ig,""),a=a.replace(/(\{{2,3}[\^#~]?)href\_src\_style\_tmplbrick\_(\d+)(\}{2,3})/g,function(a,c,d,e){return b[parseInt(d,10)]}),a=a.replace(/(\{{2,3})~/g,"$1/"),a}function Tmpler(a,b){a&&b!==!1?(this.bricks=[],this.tmpls=[],this._praseTmpl(a)):this.tmpl=a}var $=Node.all;return S.extend(Tmpler,Object,{_praseTmpl:function(a){var b=this,c=!1,d,e;if(typeof a=="string"){if(a.charAt(0)==="."||a.charAt(0)==="#"||a==="body")d=$(a)}else d=a;d&&(d.item(0)[0].tagName.toUpperCase()=="SCRIPT"?a=d.item(0).html():c=!0);if(!c){var f=/(\{{2,3}\#(.+?)\}{2,3})\s*([\s\S]*)?\s*((\{{2,3})\/\2(\}{2,3}))/g;while(f.test(a))a=a.replace(f," $1$3$5~$2$6 "),f.lastIndex=0;var g=[];a=a.replace(/(\{{2,3}[\^#~])?(if\(.*?\))(\}{2,3})?/ig,function(a,b,c,d,e,f){var h=S.indexOf(c,g),i="iftmplbrick_";return h<0?(i+=g.length,g.push(c)):i+=h,b+i+d}),a=a.replace(/((href|src|style)=("|')(.*?)("|'))/ig,function(a,b){var c=S.indexOf(b,g),d="href_src_style_tmplbrick_";return c<0?(d+=g.length,g.push(b)):d+=c,"{{#"+d+"}}"}),d=new Node(a),e=$("<div></div>").append(d),d.length>1?this.id=_stamp(e):this.id=_stamp(d)}else e=d,this.id=_stamp(e);var h=e.all("[bx-tmpl-source]");h.each(function(a){var b=a.attr("bx-tmpl-source"),c=_stamp(a,"tmpl_"),d=e.one(b).clone(!0);d.removeAttr("id"),d.insertBefore(a),a.remove(),d.attr("id",c)}),b._buildBricks(e),b._buildTmpls(e,g),c||(b.tmpl=_recovery(e.html(),g),d.remove(),e.remove()),e=null,d=null,this.inDom=c},_buildBricks:function(el){var self=this,brickNodes=el.all("[bx-name]");el.hasAttr("bx-name")&&(brickNodes=brickNodes.add(el[0])),brickNodes.each(function(brickNode){var id=_stamp(brickNode),name=brickNode.attr("bx-name"),path=brickNode.attr("bx-path"),config=brickNode.attr("bx-config");config=config?eval("config="+config):{},self.bricks.push({id:id,name:name,path:path,config:config})})},_buildTmpls:function(a,b){var c=this,d=a.all("[bx-tmpl]");a.hasAttr("bx-tmpl")&&(d=d.add(a[0])),d.each(function(a){var d=_stamp(a,"tmpl_"),e=a.attr("bx-datakey"),f=_recovery(a.html(),b);c.tmpls.push({id:d,datakey:e?e.split(","):[],tmpler:new Tmpler(f,!1)})}),d=null},addTmpl:function(a){var b=this;return S.each(a,function(a){b.tmpls.push({id:a.id,datakey:a.datakey.split(","),tmpler:new Tmpler(a.tmpl,!1)})}),!0},getTmpl:function(){return this.tmpl},to_html:function(a){return Mustache.to_html(this.getTmpl(),a)}}),Tmpler},{requires:["./mu","node","ua","sizzle"]});