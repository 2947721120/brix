KISSY.add("brix/core/tmpler",function(a,b,c,d){function f(b,c){return c=c||"brick_",b.attr("id")||b.attr("id",a.guid("brix_"+c)),b.attr("id")}function g(a){return a=a.replace(/(?:<|&lt;)!--({{[^}]+}})--(?:>|&gt;)/g,"$1").replace(/\s(src|href)\s*=\s*(['"])(.*?\{.+?)\2/g," data-templatable-$1=$2$3$2"),a}function h(a,b){a&&b!==!1?(this.tmpls=[],this._praseTmpl(a)):this.tmpl=a}var e=c.all;return a.extend(h,Object,{_praseTmpl:function(a){var b=this,d=!1,h,i;if(typeof a=="string"){if(a.charAt(0)==="."||a.charAt(0)==="#"||a==="body")h=e(a)}else h=a;h&&(h.item(0)[0].nodeName.toUpperCase()=="SCRIPT"?a=h.item(0).html():d=!0),d?(i=h,this.id=f(i)):(a=a.replace(/({[^}]+}})/g,"<!--$1-->").replace(/\s(src|href)\s*=\s*(['"])(.*?\{.+?)\2/g," data-templatable-$1=$2$3$2"),h=new c(a),i=e("<div></div>").append(h),h.length>1?this.id=f(i):this.id=f(h));var j=i.all("[bx-tmpl-source]");j.each(function(a){var b=a.attr("bx-tmpl-source"),c=f(a,"tmpl_"),d=i.one(b).clone(!0);d.removeAttr("id"),d.insertBefore(a),a.remove(),d.attr("id",c)}),d||(b._buildTmpls(i),b.tmpl=g(i.html()),h.remove(),i.remove()),i=null,h=null,this.inDom=d},_buildTmpls:function(a){var b=this,c=a.all("[bx-tmpl]");a.hasAttr("bx-tmpl")&&(c=c.add(a[0])),c.each(function(a){var c=f(a,"tmpl_"),d=a.attr("bx-datakey"),e=g(a.html());b.tmpls.push({id:c,datakey:d?d.split(","):[],tmpler:new h(e,!1)})}),c=null},addTmpl:function(b){var c=this;return a.each(b,function(a){c.tmpls.push({id:a.id,datakey:a.datakey.split(","),tmpler:new h(a.tmpl,!1)})}),!0},getTmpl:function(){return this.tmpl},to_html:function(a){return b.to_html(this.getTmpl(),a)}}),h},{requires:["./mu","node","ua","sizzle"]});