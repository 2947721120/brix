/*
Copyright 2011, KISSY UI Library v1.20dev
MIT Licensed
build time: Nov 30 19:02
*/
KISSY.add("mvc/base",function(h,m){return{sync:m}},{requires:["./sync"]});
KISSY.add("mvc/collection",function(h,m,n,k,l){function b(){b.superclass.constructor.apply(this,arguments)}b.ATTRS={model:{value:n},models:{setter:function(a){this.remove(this.get("models"),{silent:1});this.add(a,{silent:1});return this.get("models")},value:[]},url:{value:h.noop},comparator:{},sync:{value:function(){k.sync.apply(this,arguments)}},parse:{value:function(a){return a}}};h.extend(b,l,{sort:function(){var a=this.get("comparator");a&&this.get("models").sort(function(c,d){return a(c)-a(d)})},
toJSON:function(){return h.map(this.get("models"),function(a){return a.toJSON()})},add:function(a,c){var d=this,f=true;if(h.isArray(a)){var i=[].concat(a);h.each(i,function(o){o=d._add(o,c);f=f&&o})}else f=d._add(a,c);return f},remove:function(a,c){var d=this;if(h.isArray(a)){var f=[].concat(a);h.each(f,function(i){d._remove(i,c)})}else a&&d._remove(a,c)},at:function(a){return this.get("models")[a]},_normModel:function(a){var c=true;if(!(a instanceof n)){c=a;a=new (this.get("model"));c=a.set(c,{silent:1})}return c&&
a},load:function(a){var c=this;a=a||{};var d=a.success;a.success=function(f){if(f){var i=c.get("parse").call(c,f);i&&c.set("models",i,a)}d&&d.apply(this,arguments)};c.get("sync").call(c,c,"read",a);return c},create:function(a,c){var d=this;c=c||{};if(a=this._normModel(a)){a.addToCollection(d);var f=c.success;c.success=function(){d.add(a,c);f&&f()};a.save(c)}return a},_add:function(a,c){if(a=this._normModel(a)){c=c||{};var d;d=this.get("models");var f=this.get("comparator"),i=d.length;if(f){var o=
f(a);for(i=0;i<d.length;i++){var y=f(d[i]);if(o<y)break}}d=i;this.get("models").splice(d,0,a);a.addToCollection(this);c.silent||this.fire("add",{model:a})}return a},_remove:function(a,c){c=c||{};var d=h.indexOf(a,this.get("models"));if(d!=-1){this.get("models").splice(d,1);a.removeFromCollection(this)}c.silent||this.fire("remove",{model:a})},getById:function(a){for(var c=this.get("models"),d=0;d<c.length;d++){var f=c[d];if(f.getId()===a)return f}return null},getByCid:function(a){for(var c=this.get("models"),
d=0;d<c.length;d++){var f=c[d];if(f.get("clientId")===a)return f}return null}});return b},{requires:["event","./model","./base","base"]});
KISSY.add("mvc/model",function(h,m,n){function k(){k.superclass.constructor.apply(this,arguments);this.publish("*Change",{bubbles:1});this.collections={}}var l=["idAttribute","clientId","urlRoot","url","parse","sync"];h.extend(k,m,{addToCollection:function(b){this.collections[h.stamp(b)]=b;this.addTarget(b)},removeFromCollection:function(b){delete this.collections[h.stamp(b)];this.removeTarget(b)},getId:function(){return this.get(this.get("idAttribute"))},setId:function(b){return this.set(this.get("idAttribute"),
b)},__set:function(){this.__isModified=1;return k.superclass.__set.apply(this,arguments)},isNew:function(){return!this.getId()},isModified:function(){return!!(this.isNew()||this.__isModified)},destroy:function(b){var a=this;b=b||{};var c=b.success;b.success=function(d){var f=a.collections;d&&a.set(d,b);for(var i in f){f[i].remove(a,b);a.removeFromCollection(f[i])}a.fire("destroy");c&&c.apply(this,arguments)};if(!a.isNew()&&b["delete"])a.get("sync").call(a,a,"delete",b);else{b.success();b.complete&&
b.complete()}return a},load:function(b){var a=this;b=b||{};var c=b.success;b.success=function(d){if(d){var f=a.get("parse").call(a,d);f&&a.set(f,b)}a.__isModified=0;c&&c.apply(this,arguments)};a.get("sync").call(a,a,"read",b);return a},save:function(b){var a=this;b=b||{};var c=b.success;b.success=function(d){if(d){var f=a.get("parse").call(a,d);f&&a.set(f,b)}a.__isModified=0;c&&c.apply(this,arguments)};a.get("sync").call(a,a,a.isNew()?"create":"update",b);return a},toJSON:function(){var b=this.getAttrVals();
h.each(l,function(a){delete b[a]});return b}},{ATTRS:{idAttribute:{value:"id"},clientId:{valueFn:function(){return h.guid("mvc-client")}},url:{value:function(){var b,a,c=this.collections;for(b in c)if(c.hasOwnProperty(b)){a=c[b];break}b=a;var d;b=b&&(d=b.get("url"))?h.isString(d)?d:d.call(b):d;d=b||this.get("urlRoot");if(this.isNew())return d;d+=d.charAt(d.length-1)=="/"?"":"/";return d+encodeURIComponent(this.getId())+"/"}},urlRoot:{value:""},sync:{value:function(){n.sync.apply(this,arguments)}},
parse:{value:function(b){return b}}}});return k},{requires:["base","./base"]});
KISSY.add("mvc/router",function(h,m,n){function k(e){var g,j;for(j=0;j<e.length;j++){g=e.charAt(j);if(g=="\\")j++;else if(g=="(")return j}throw Error("impossible to not to get capture group in kissy mvc route");}function l(){return q.nativeHistory&&z?r.pathname.substr(q.urlRoot.length)+r.search:r.href.replace(/^[^#]*#?!?(.*)$/,"$1")}function b(e){if(h.endsWith(e,"/"))e=e.substring(0,e.length-1);return e}function a(e){if(h.startsWith(e,"/"))e=e.substring(1);return e}function c(e,g){e=b(e);g=b(g);return e==
g}function d(e){if(e=e.match(I))return h.unparam(e[1]);return{}}function f(){var e=l(),g=e,j=0,p=-1,t="",w=-1,F=0,v=0;e=g.replace(I,"");A(J,function(G){var x=0;A(G[H],function(s){var B=s.regStr,K=s.paramNames,C=-1,u,M=s.callback;if(u=e.match(s.reg)){u.shift();var P=function(){if(K){var L={};A(u,function(N,O){L[K[O]]=N});return L}else return[].concat(u)};s=function(){t=B;w=C;F=M;v=P();j=G;p=u.length};if(u.length)if(B){C=k(B);if(C>w)s();else if(C==w&&p>=u.length)if(u.length<p)s();else B.length>t.length&&
s();else j||s()}else s();else{s();x=1;return false}}});if(x)return false});if(v){g=d(g);F.apply(j,[v,g]);g={name:name,paths:v,query:g};j.fire("route:"+name,g);j.fire("route",g)}}function i(e,g,j){var p=g,t=[];if(h.isFunction(j)){g=h.escapeRegExp(g);g=g.replace(Q,function(w,F,v,G,x){t.push(v||x);if(v)return"([^/]+)";else if(x)return"(.*)"});return{name:p,paramNames:t,reg:RegExp("^"+g+"$"),regStr:g,callback:j}}else return{name:p,reg:j.reg,callback:o(e,j.callback)}}function o(e,g){if(h.isFunction(g))return g;
else if(h.isString(g))return e[g];return g}function y(e){this[H]={};this.addRoutes(e.newVal)}function q(){q.superclass.constructor.apply(this,arguments);this.on("afterRoutesChange",y,this);y.call(this,{newVal:this.get("routes")});J.push(this)}var I=/\?(.*)/,A=h.each,Q=/(:([\w\d]+))|(\\\*([\w\d]+))/g,J=[],D=window,r=D.location,E=D.history,z=!!(E&&E.pushState),H="__routerMap";q.ATTRS={routes:{}};h.extend(q,n,{addRoutes:function(e){var g=this;A(e,function(j,p){g[H][p]=i(g,p,o(g,j))})}},{navigate:function(e,
g){if(l()!==e)if(q.nativeHistory&&z){E.pushState({},"",r.protocol+"//"+r.host+b(q.urlRoot)+("/"+a(e)));f()}else r.hash="!"+e;else g&&g.triggerRoute&&f()},start:function(e){e=e||{};e.urlRoot=e.urlRoot||"";var g,j=e.nativeHistory,p=r.pathname,t=l(),w=r.hash.match(/#!.+/);g=q.urlRoot=e.urlRoot;if(q.nativeHistory=j)if(z){if(w)if(c(p,g)){E.replaceState({},"",r.protocol+"//"+r.host+b(q.urlRoot)+("/"+a(t)));e.triggerRoute=1}}else if(!c(p,g)){r.replace(b(g)+"/#!"+t);return}setTimeout(function(){if(j&&z)m.on(D,
"popstate",f);else{m.on(D,"hashchange",f);e.triggerRoute=1}e.triggerRoute&&f();e.success&&e.success()},100)}});return q},{requires:["event","base"]});KISSY.add("mvc/sync",function(h,m){var n={create:"POST",update:"POST","delete":"POST",read:"GET"};return function(k,l,b){b=h.merge({type:n[l],dataType:"json"},b);var a=b.data=b.data||{};a._method=l;if(!b.url)b.url=h.isString(k.get("url"))?k.get("url"):k.get("url").call(k);if(l=="create"||l=="update")a.model=k.toJSON();return m(b)}},{requires:["ajax"]});
KISSY.add("mvc/view",function(h,m,n){function k(a,c){if(h.isString(c))return a[c];return c}function l(){l.superclass.constructor.apply(this,arguments);var a;if(a=this.get("events"))this._afterEventsChange({newVal:a})}var b=m.all;l.ATTRS={el:{value:"<div />",getter:function(a){if(h.isString(a)){a=b(a);this.__set("el",a)}return a}},events:{}};h.extend(l,n,{_afterEventsChange:function(a){var c=a.prevVal;c&&this._removeEvents(c);this._addEvents(a.newVal)},_removeEvents:function(a){var c=this.get("el"),
d;for(d in a){var f=a[d],i;for(i in f){var o=k(this,f[i]);c.undelegate(i,d,o,this)}}},_addEvents:function(a){var c=this.get("el"),d;for(d in a){var f=a[d],i;for(i in f){var o=k(this,f[i]);c.delegate(i,d,o,this)}}},render:function(){return this},destroy:function(){this.get("el").remove()}});return l},{requires:["node","base"]});KISSY.add("mvc",function(h,m,n,k,l,b){return h.mix(m,{Model:n,View:l,Collection:k,Router:b})},{requires:["mvc/base","mvc/model","mvc/collection","mvc/view","mvc/router"]});
